<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Simulating power for mixed-effects models</title>

    <meta name="author" content="Dale J. Barr" />
  
   <meta name="description" content="Workshop at AMLaP Asia, November 30, 2023." />
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="Simulating power for mixed-effects models" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="<a href="https://dalejbarr.github.io/aa-powersim" class="uri">https://dalejbarr.github.io/aa-powersim</a>" />
  
  <meta property="og:description" content="Workshop at AMLaP Asia, November 30, 2023." />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Simulating power for mixed-effects models" />
  
  <meta name="twitter:description" content="Workshop at AMLaP Asia, November 30, 2023." />
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.8.0/transition.js"></script>
    <script src="libs/bs3compat-0.8.0/tabs.js"></script>
    <script src="libs/bs3compat-0.8.0/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6NP3MF25W3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-6NP3MF25W3');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  <style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
    <style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
      <link rel="stylesheet" href="include/psyteachr.css" />
    <link rel="stylesheet" href="include/webex.css" />
    <link rel="stylesheet" href="include/style.css" />
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<!--bookdown:title:start-->
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Simulating power for mixed-effects models</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="workshop-simulating-power-for-mixed-effects-models" class="section level1 unnumbered">
<h1 class="unnumbered">Workshop: Simulating power for mixed-effects models</h1>
<p><em>Dale J. Barr</em></p>
<p><strong><a href="http://ling.cuhk.edu.hk/amlap.asia/">AMLaP Asia</a>, November 30, 2023</strong></p>
<div id="background" class="section level2 unnumbered">
<h2 class="unnumbered">Background</h2>
<p>Materials for a practical one-day workshop aimed at conference attendees who are interested in utilizing linear mixed-effects models in their research. Led by Dr. Dale Barr from the University of Glasgow, this workshop provides an introduction to simulating power in linear mixed-effects models.</p>
<p>Two pre-requisites for the workshop are: (1) basic understanding of linear regression and (2) some familiarity with the R statistical programming environment (<a href="https://cran.r-project.org" class="uri">https://cran.r-project.org</a>). Please have R and RStudio installed on your laptop prior to the start of the workshop, including the packages <strong><code>{tidyverse}</code></strong> and <strong><code>lme4</code></strong>.</p>
</div>
<div id="workshop-plan" class="section level2 unnumbered">
<h2 class="unnumbered">Workshop plan</h2>
<ul>
<li><p><em>Part 1</em> (9:00-12:00): <strong>Building blocks of simulation</strong></p>
<p>Provides an overview of critical programming skills for Monte Carlo simulation. We will build these skills by writing a script for a power simulation for a one-sample t-test.</p></li>
<li><p><em>Part 2</em> (14:00-17:00): <strong>Simulating power in linear mixed-effects models</strong></p>
<p>Conceptual introduction to the data generating process (DGP) behind many models in psycholinguistics, and instructions on how to adapt the script generated in Part 1 to a mixed-model context.</p></li>
</ul>
</div>
<div id="notes-on-these-materials" class="section level2 unnumbered">
<h2 class="unnumbered">Notes on these materials</h2>
<p>These materials comprise an <strong>interactive textbook</strong>. Each "chapter" contains embedded exercises as well as web applications to help participants better understand the content. The interactive content will only work if you access this material through a web browser. Printing out the material is not recommended.</p>
<p>It would be good to keep a local copy of these materials in case the website eventually disappears. You can <a href="amlap-asia-power-simulation.zip" target="_download">download an offline version</a> of these materials. It contains the current snapshot. Because things are likely to change while the workshop is ongoing, it would be best to wait until the end of the workshop before downloading a permanent version.</p>
<p>Once you've downloaded the archive, just extract the files, locate the file <code>index.html</code> in the <code>docs</code> directory, and open this file using a web browser.</p>
<p>You are free to re-use and modify the material in this textbook for your own purposes, with the stipulation that you cite the original work. Please note additional terms of the <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons CC-BY-SA 4.0 license</a> governing re-use of this material.</p>
<blockquote>
<p>Barr, Dale J. (2023). Simulating power for mixed-effects models (workshop materials). Downloaded from <a href="https://dalejbarr.github.io/aa-powersim" class="uri">https://dalejbarr.github.io/aa-powersim</a>.</p>
</blockquote>
<p>The book was built using the R <a href="https://bookdown.org"><strong><code>bookdown</code></strong></a> package. The source files are available at <a href="https://github.com/dalejbarr/aa-powersim">github</a>.</p>
</div>
<div id="found-an-issue" class="section level2 unnumbered">
<h2 class="unnumbered">Found an issue?</h2>
<p>If you find errors or typos, have questions or suggestions, please file an issue at <a href="https://github.com/dalejbarr/aa-powersim/issues" class="uri">https://github.com/dalejbarr/aa-powersim/issues</a>. Thanks!</p>
<!--chapter:end:index.Rmd-->
</div>
</div>
<div id="building-blocks-of-simulation" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Building blocks of simulation</h1>
<div id="coding-preliminaries" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Coding preliminaries</h2>
<p>If the main thing you do when using R is analyzing data, then it is likely that you haven't been exposed to many of the features of R and the tidyverse that are needed for data simulation, including random number generation (@ref(rng)), writing custom functions (@ref(funcs)), iteration (@ref(iterate)), nested tables (@ref(nesting)), handling warnings and messages (@ref(trapping)), and extracting statistics from model objects (@ref(extract)).</p>
<p>We will start by providing a basic overview on each of these topics through the task of generating an R script that performs a power simulation for a one-sample t-test for various effect and sample sizes. Although there are analytical solutions for computing power for this type of test, it is worth learning the general principles before dealing with the complexities of linear mixed-effects models.</p>
<p>In what follows, I will assume that you are familiar with how "pipes" work in R (either the base pipe, <code>|&gt;</code> or the dplyr pipe, <code>%&gt;%</code>) and the following one-table verbs from dplyr: <code>select()</code>, <code>mutate()</code>, and <code>summarize()</code>.</p>
<div id="setting-up-the-environment" class="section level3" number="1.1.1">
<h3><span class="header-section-number">1.1.1</span> Setting up the environment</h3>
<p>When you're developing an R script, it is good practice to load in the packages you need at the top of the script.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;dplyr&quot;</span>)  <span class="co"># select(), mutate(), summarize(), inner_join()</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;tibble&quot;</span>) <span class="co"># tibble() [data entry]</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;purrr&quot;</span>)  <span class="co"># just for map()</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;tidyr&quot;</span>)  <span class="co"># nest(), unnest()</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">requireNamespace</span>(<span class="st">&quot;broom&quot;</span>) <span class="co"># don&#39;t load, just fail if it&#39;s not there</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>})</span></code></pre></div>
<p>We have wrapped these calls in <code>suppressPackageStartupMessages()</code> so that when don't get any of the messages that come up when packages are loaded each time we run the script. We are just using tidyverse functions anyway, so there shouldn't be any problems.</p>
</div>
<div id="rng" class="section level3" number="1.1.2">
<h3><span class="header-section-number">1.1.2</span> Random number generation</h3>
<p>Simulating data means simulating random processes. Usually the random process we are trying to mimic is that of <strong>sampling</strong>, i.e., drawing a (presumably random) sample from a population.</p>
<p>This involves randomly generating numbers from some kind of statistical distribution. For many purposes we will use the univariate normal distribution via the function <code>rnorm()</code>, which is included in base R. If we want to simulate data from a multivariate normal distribution (which we will do in the next section), then we can use <code>MASS::mvrnorm()</code>.</p>
<p>The key arguments to <code>rnorm()</code> are:</p>
<table>
<tbody>
<tr class="odd">
<td><code>n</code></td>
<td>the number of observations we want</td>
</tr>
<tr class="even">
<td><code>mean</code></td>
<td>the population mean of the distribution (default 0)</td>
</tr>
<tr class="odd">
<td><code>sd</code></td>
<td>the population standard deviation (default 1)</td>
</tr>
</tbody>
</table>
<p><strong>TASK: simulate 10 observations from a normal distribution with a mean of 0 and standard deviation of 5.</strong></p>
<div class="webex-solution">
<button>
Solution
</button>
<p>rnorm(10, sd = 5)</p>
</div>
<p>Functions like <code>rnorm()</code> will give you random output based on the state of the internal random number generator (RNG). If we want to get a deterministic output, we can "seed" the random number generator using <code>set.seed()</code>. (Often it makes sense to do this once, at the top of a script.) The function <code>set.seed()</code> takes a single argument, which is an arbitrary integer value that provides the 'starting point'.</p>
<p><strong>TASK: set the seed to 1451 and then simulate 15 observations from a normal distribution with a mean of 600 and standard deviation of 80. If you do this right, your output should EXACTLY match the output below.</strong></p>
<pre><code>##  [1] 383.2186 522.1162 503.1198 640.4056 628.0002 759.7153 595.5522 516.1018
##  [9] 479.3662 587.9051 775.4601 684.2209 671.1479 597.2221 618.4092</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">15</span>, <span class="at">mean =</span> <span class="dv">600</span>, <span class="at">sd =</span> <span class="dv">80</span>)</span></code></pre></div>
</div>
</div>
<div id="iterate" class="section level3" number="1.1.3">
<h3><span class="header-section-number">1.1.3</span> Iterating using <code>purrr::map()</code></h3>
<p>To estimate power using simulation, we need to create our function and then run it many times—maybe 1,000 or 10,000 times to get a reliable estimate. Of course, we are not going to type a function call to do it that many times; it would be tedious, and besides, we might make mistakes. What we need is something to do the iteration for us, possible changing the input to our function each time.</p>
<p>In many programming languages, this is accomplished by writing a "for" loop. This is possible in R as well, but we're going to do this a different way that saves typing.</p>
<p>We are going to use the function <code>purrr::map()</code>. Let's look at an example. Suppose we had a vector of integers, <code>x</code>, and wanted to compute the logarithm (<code>log()</code>) of each one. If we didn't know about <code>map()</code>, we might type the following.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="dt">L</span>, <span class="dv">4</span><span class="dt">L</span>, <span class="dv">7</span><span class="dt">L</span>, <span class="dv">9</span><span class="dt">L</span>, <span class="dv">14</span><span class="dt">L</span>) <span class="co"># the &#39;L&#39; after each number means &quot;long integer&quot;</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="fu">log</span>(x[<span class="dv">1</span>])</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="fu">log</span>(x[<span class="dv">2</span>])</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">log</span>(x[<span class="dv">3</span>])</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="fu">log</span>(x[<span class="dv">4</span>])</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="fu">log</span>(x[<span class="dv">5</span>])</span></code></pre></div>
<pre><code>## [1] 0
## [1] 1.386294
## [1] 1.94591
## [1] 2.197225
## [1] 2.639057</code></pre>
<p>That's a lot of typing. With <code>map()</code>, we can just type this.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">map</span>(x, log)</span></code></pre></div>
<pre><code>## [[1]]
## [1] 0
## 
## [[2]]
## [1] 1.386294
## 
## [[3]]
## [1] 1.94591
## 
## [[4]]
## [1] 2.197225
## 
## [[5]]
## [1] 2.639057</code></pre>
<p>Note that the output comes in the form of a list. If we wanted the output to be a vector of doubles, we could use <code>map_dbl()</code> instead.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">map_dbl</span>(x, log)</span></code></pre></div>
<pre><code>## [1] 0.000000 1.386294 1.945910 2.197225 2.639057</code></pre>
<p>Now, by default, <code>log()</code> gives the natural logarithm (using base <span class="math inline">\(e\)</span>, Euler's number). What if we want to change the base? To do that we'd have to pass an additional argument <code>base = 2</code> to log within map. We could add that like so</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">map_dbl</span>(x, log, <span class="at">base =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## [1] 0.000000 2.000000 2.807355 3.169925 3.807355</code></pre>
<p>But this makes the syntax unclear: Is <code>base = 2</code> an argument to <code>map_dbl()</code>, or to <code>log()</code>? Technically, it's an argument to map that is passed along to <code>log()</code>, but that is confusing. This makes things needlessly hard to debug. So the recommended way to do this is to call <code>log()</code> within <code>map()</code> as part of an anonymous function.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">map_dbl</span>(x, \(.x) <span class="fu">log</span>(.x, <span class="at">base =</span> <span class="dv">2</span>))</span></code></pre></div>
<pre><code>## [1] 0.000000 2.000000 2.807355 3.169925 3.807355</code></pre>
<p>This allows us to call <code>log()</code> in the "normal" way (i.e., the way we would do it if typing in the console. The <code>\(.x)</code> says to R "pass along the value from <code>x</code> you're currently working with to the function on the right hand side, giving this new value <code>.x</code>". Also, making explicit the passing of the value from <code>map()</code> to the function you wish to repeat makes it easy to work with situations where the varying value is not the first argument of that function.</p>
<p>If you have multiple arguments you need to pass to the function, you can do this using <code>purrr::pmap()</code>, whose first argument takes a list of function arguments.</p>
<p>For a deep dive into the topic of iteration, see <a href="https://r4ds.hadley.nz/iteration">R for Data Science by Wickham, Çentinkaya-Rundel, and Grolemund</a>.</p>
<p><strong>TASK: Write a call to <code>map_dbl()</code> that calculates the log of 3 but with bases varying from 2 to 7.</strong></p>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">map_dbl</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>, \(.x) <span class="fu">log</span>(<span class="dv">3</span>, <span class="at">base =</span> .x))</span></code></pre></div>
<pre><code>## [1] 1.5849625 1.0000000 0.7924813 0.6826062 0.6131472 0.5645750</code></pre>
</div>
</div>
<div id="creating-tibbles" class="section level3" number="1.1.4">
<h3><span class="header-section-number">1.1.4</span> Creating "tibbles"</h3>
<p>Much of what we'll be doing will involve working with datasets stored in tables, or <strong>tabular data</strong> (in R, a table is also called a <code>data.frame</code>). When you're analyzing data, you usually create these tables by importing data from a file (e.g., a CSV or Excel file with experiment data).</p>
<p>When you're simulating data, you need to create these tables yourself. The <code>tibble</code> package has functions that help make this easier. For current purposes, really the only function we need from this package is <code>tibble::tibble()</code>, which is an enhanced version of the base R <code>data.frame()</code> for manual data entry.</p>
<p>Let's assume we're creating information about the participants in a study. Each participant is given a unique <code>id</code> and we have recorded information about their age. We can enter this into a tibble() like so.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>participants <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="dt">L</span>, <span class="dv">2</span><span class="dt">L</span>, <span class="dv">3</span><span class="dt">L</span>, <span class="dv">4</span><span class="dt">L</span>, <span class="dv">5</span><span class="dt">L</span>),</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>                       <span class="at">age =</span> <span class="fu">c</span>(<span class="dv">27</span><span class="dt">L</span>, <span class="dv">18</span><span class="dt">L</span>, <span class="dv">43</span><span class="dt">L</span>, <span class="dv">72</span><span class="dt">L</span>, <span class="dv">21</span><span class="dt">L</span>))</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>participants</span></code></pre></div>
<pre><code>## # A tibble: 5 × 2
##      id   age
##   &lt;int&gt; &lt;int&gt;
## 1     1    27
## 2     2    18
## 3     3    43
## 4     4    72
## 5     5    21</code></pre>
<div id="save-typing-with-rep-seq-and-seq_len" class="section level4" number="1.1.4.1">
<h4><span class="header-section-number">1.1.4.1</span> Save typing with <code>rep()</code>, <code>seq()</code>, and <code>seq_len()</code></h4>
<p>Let's now say you are going to run these participants on a <a href="https://en.wikipedia.org/wiki/Stroop_effect">Stroop interference task</a> where they see color words printed in congruent or incongruent colors (e.g., the word "RED" printed in red font or green font) and have to name the color of the font. Let's assume that each person gets each word twice, once in the congruent condition and once in the incongruent condition. Now you want to make a table that has each of the six colors in each condition. The resulting table should look like this.</p>
<pre><code>## # A tibble: 12 × 2
##    word   cond       
##    &lt;chr&gt;  &lt;chr&gt;      
##  1 red    congruent  
##  2 red    incongruent
##  3 green  congruent  
##  4 green  incongruent
##  5 blue   congruent  
##  6 blue   incongruent
##  7 yellow congruent  
##  8 yellow incongruent
##  9 purple congruent  
## 10 purple incongruent
## 11 orange congruent  
## 12 orange incongruent</code></pre>
<p>We could type all that out manually but it would be tedious and prone to typos. Fortunately R has a function <code>rep()</code> that allows us to repeat values. Study the code below. until you understand how it works.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">each =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##  [1] 1 1 1 2 2 2 3 3 3 4 4 4</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">rep</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">times =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##  [1] 5 6 7 5 6 7 5 6 7 5 6 7</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">rep</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">0</span>))</span></code></pre></div>
<pre><code>## [1] 8 8 9 9 9</code></pre>
<p><strong>TASK: Write code to recreate the Stroop stimuli table shown above using <code>rep()</code> to define the column values. Name the resulting table <code>stimuli</code>.</strong></p>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>stimuli <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">word =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;yellow&quot;</span>,</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>                               <span class="st">&quot;purple&quot;</span>, <span class="st">&quot;orange&quot;</span>), <span class="at">each =</span> <span class="dv">2</span>),</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>                  <span class="at">cond =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;congruent&quot;</span>, <span class="st">&quot;incongruent&quot;</span>), <span class="at">times =</span> <span class="dv">6</span>))</span></code></pre></div>
</div>
<p>Two other functions that are useful in simulation are <code>seq_len()</code> and <code>seq()</code>. We'll e using these later. Examples are below.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="do">## sequence of integers 1:length.out;</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="do">## if length.out == 0 then &#39;empty&#39;</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="fu">seq_len</span>(<span class="at">length.out =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## [1] 1 2 3 4</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2</span>, <span class="at">to =</span> <span class="dv">7</span>, <span class="at">by =</span> .<span class="dv">5</span>)</span></code></pre></div>
<pre><code>##  [1] 2.0 2.5 3.0 3.5 4.0 4.5 5.0 5.5 6.0 6.5 7.0</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2</span>, <span class="at">to =</span> <span class="dv">7</span>, <span class="at">length.out =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1] 2.00 3.25 4.50 5.75 7.00</code></pre>
</div>
<div id="nesting" class="section level4" number="1.1.4.2">
<h4><span class="header-section-number">1.1.4.2</span> Nested tibbles</h4>
<p>Tibbles, like the <code>data.frame</code> class from which they are derived, are just specialized list structures. Lists are useful as data structures because unlike vectors, each element can be of a different data type (character, integer, double, factor). To be data frames, however, it is essential that each list element has the same length (number of elements).</p>
<p>A great feature of tibbles that differs from <code>data.frame</code> objects is that they can have columns whose values are themselves... tibbles. That is, we can have tibbles inside of tibbles, but we have to define those columns using the <code>list()</code> function.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="do">## just basic tibbles</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>beatles <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">&quot;John&quot;</span>, <span class="st">&quot;Paul&quot;</span>, <span class="st">&quot;Ringo&quot;</span>, <span class="st">&quot;George&quot;</span>),</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>                  <span class="at">instrument =</span> <span class="fu">c</span>(<span class="st">&quot;guitar&quot;</span>, <span class="st">&quot;bass&quot;</span>, <span class="st">&quot;drums&quot;</span>, <span class="st">&quot;guitar&quot;</span>))</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>rolling_stones <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">&quot;Keith&quot;</span>, <span class="st">&quot;Mick&quot;</span>, <span class="st">&quot;Charlie&quot;</span>, <span class="st">&quot;Bill&quot;</span>),</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>                         <span class="at">instrument =</span> <span class="fu">c</span>(<span class="st">&quot;guitar&quot;</span>, <span class="st">&quot;vocals&quot;</span>, <span class="st">&quot;drums&quot;</span>, <span class="st">&quot;bass&quot;</span>))</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a><span class="do">## a tibble with tibbles as elements</span></span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>boomer_bands <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">band_name =</span> <span class="fu">c</span>(<span class="st">&quot;Beatles&quot;</span>, <span class="st">&quot;Rolling Stones&quot;</span>),</span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>                       <span class="at">band_members =</span> <span class="fu">list</span>(beatles, rolling_stones))</span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a>boomer_bands</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   band_name      band_members    
##   &lt;chr&gt;          &lt;list&gt;          
## 1 Beatles        &lt;tibble [4 × 2]&gt;
## 2 Rolling Stones &lt;tibble [4 × 2]&gt;</code></pre>
<p>And if we then wanted to "expand" these nested tables we can do so using <code>tidyr::unnest()</code>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>bb2 <span class="ot">&lt;-</span> boomer_bands <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>  <span class="fu">unnest</span>(band_members)</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>bb2</span></code></pre></div>
<pre><code>## # A tibble: 8 × 3
##   band_name      name    instrument
##   &lt;chr&gt;          &lt;chr&gt;   &lt;chr&gt;     
## 1 Beatles        John    guitar    
## 2 Beatles        Paul    bass      
## 3 Beatles        Ringo   drums     
## 4 Beatles        George  guitar    
## 5 Rolling Stones Keith   guitar    
## 6 Rolling Stones Mick    vocals    
## 7 Rolling Stones Charlie drums     
## 8 Rolling Stones Bill    bass</code></pre>
<p>And if we wanted to, we can then reverse the operation.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>bb2 <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">band_members =</span> <span class="fu">c</span>(name, instrument))</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   band_name      band_members    
##   &lt;chr&gt;          &lt;list&gt;          
## 1 Beatles        &lt;tibble [4 × 2]&gt;
## 2 Rolling Stones &lt;tibble [4 × 2]&gt;</code></pre>
<p>Why is this useful? Well, mostly because it elegantly allows us to account for the multilevel structure of data, such as when you have trials nested within participants. But we'll see shortly how we can combine this with <code>map()</code> (which returns a list) to make columns whose elements are tibbles of simulated data, or analyses performed on those tibbles.</p>
</div>
</div>
<div id="combining-tibbles" class="section level3" number="1.1.5">
<h3><span class="header-section-number">1.1.5</span> Combining tibbles</h3>
<p>Often you'll end up with data scattered across different tables and need to merge it into a single table. The tidyverse provides powerful and efficient functions for merging data.</p>
<div id="cartesian-join-with-dplyrcross_join" class="section level4" number="1.1.5.1">
<h4><span class="header-section-number">1.1.5.1</span> Cartesian join with <code>dplyr::cross_join()</code></h4>
<p>Occasionally what we want to do is combine all possible combinations of rows across two tables, in what is known as a "Cartesian join." For this, we can use the function <code>dplyr::cross_join()</code>. This is easiest to explain by an example.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>some_letters <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">letter =</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>))</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a>some_numbers <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">numbers =</span> <span class="fu">seq_len</span>(<span class="dv">3</span>))</span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a><span class="fu">cross_join</span>(some_letters, some_numbers)</span></code></pre></div>
<pre><code>## # A tibble: 9 × 2
##   letter numbers
##   &lt;chr&gt;    &lt;int&gt;
## 1 A            1
## 2 A            2
## 3 A            3
## 4 B            1
## 5 B            2
## 6 B            3
## 7 C            1
## 8 C            2
## 9 C            3</code></pre>
<p><strong>TASK: Above, we created the table <code>participants</code> and <code>stimuli</code>. Combine these two tables to create a table <code>trials</code> which creates all the possible trials in an experiment where each participant sees each stimulus once. The resulting table should have 60 rows. Before combining the tables, remove the column named <code>age</code> from <code>participants</code>.</strong></p>
<div class="webex-solution">
<button>
Solution
</button>
<pre><code>## # A tibble: 60 × 3
##       id word   cond       
##    &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;      
##  1     1 red    congruent  
##  2     1 red    incongruent
##  3     1 green  congruent  
##  4     1 green  incongruent
##  5     1 blue   congruent  
##  6     1 blue   incongruent
##  7     1 yellow congruent  
##  8     1 yellow incongruent
##  9     1 purple congruent  
## 10     1 purple incongruent
## # ℹ 50 more rows</code></pre>
</div>
</div>
<div id="inner-join-with-dplyrinner_join" class="section level4" number="1.1.5.2">
<h4><span class="header-section-number">1.1.5.2</span> Inner join with <code>dplyr::inner_join()</code></h4>
<p>Sometimes what you need to do is combine information from two tables but you don't want all possible combinations; rather, you want to keep the rows from both tables that match on certain 'key' values.</p>
<p>For example, in the <code>participants</code> table we have each participant's age. If we wanted to combine that information with the information in <code>trials</code> (e.g., in order to analyze Stroop interference across age), then we'd need a way to get the <code>age</code> variable into <code>trials</code>. For this we can use an <code>inner_join()</code>, specifying the <code>key</code> column in the <code>by</code> argument to the function.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>participants <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>  <span class="fu">inner_join</span>(trials, <span class="at">by =</span> <span class="fu">join_by</span>(id))</span></code></pre></div>
<pre><code>## # A tibble: 60 × 4
##       id   age word   cond       
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;      
##  1     1    27 red    congruent  
##  2     1    27 red    incongruent
##  3     1    27 green  congruent  
##  4     1    27 green  incongruent
##  5     1    27 blue   congruent  
##  6     1    27 blue   incongruent
##  7     1    27 yellow congruent  
##  8     1    27 yellow incongruent
##  9     1    27 purple congruent  
## 10     1    27 purple incongruent
## # ℹ 50 more rows</code></pre>
</div>
</div>
<div id="funcs" class="section level3" number="1.1.6">
<h3><span class="header-section-number">1.1.6</span> Writing custom functions</h3>
<p>In Monte Carlo simulation, you'll need to do the same thing (or variations on the same thing) over and over. Inevitably this means writing a 'function' that encapsulates some process. In the next section, where we learn about power simulation workflow, we'll write our own custom functions to simulate a data set (<code>generate_data()</code>), analyze the data (<code>analyze_data()</code>) and extract statistics (<code>extract_stats()</code>).</p>
<p>To create a function, you define an object using the function named <code>function()</code>. That sounds more confusing than it is, so let's jump right into an example. Suppose we want a function that adds two numbers together, <code>x</code>, and <code>y</code>, and returns the sum.</p>
<p>The code below will do the trick.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>add_x_to_y <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>  x <span class="sc">+</span> y</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>}</span></code></pre></div>
<p>Now that we've defined the function, we can call it.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="fu">add_x_to_y</span>(<span class="dv">2</span>, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] 5</code></pre>
<p>Once we've defined it, it works like any other function in R. We can use it in <code>map()</code>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, \(.x) <span class="fu">add_x_to_y</span>(.x, <span class="dv">10</span>))</span></code></pre></div>
<pre><code>## [[1]]
## [1] 11
## 
## [[2]]
## [1] 12
## 
## [[3]]
## [1] 13
## 
## [[4]]
## [1] 14
## 
## [[5]]
## [1] 15</code></pre>
<p>The part between the curly brackets defines the <strong>function body</strong>, which is where all of the computation happens. Data within the function is <strong>encapsulated</strong>—any variables that you define inside the function will be forgotten and wiped from memory after the function runs. By convention, results from the very last computation are returned to the calling process.</p>
<p>Sometimes it's useful to specify default arguments to save the user typing. So we might want to make the default value of <code>y</code> be 10.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>add_x_to_y <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> <span class="dv">10</span>) {</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>  x <span class="sc">+</span> y</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>}</span></code></pre></div>
<p>Now if we omit <code>y</code> it will set it to 10.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="fu">add_x_to_y</span>(<span class="dv">15</span>)</span></code></pre></div>
<pre><code>## [1] 25</code></pre>
</div>
</div>
<div id="power-simulation-basic-workflow" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Power simulation: Basic workflow</h2>
<div class="figure" style="text-align: center">
<img src="img/flow_3.png" alt="The basic workflow behind power simulation." width="60%" />
<p class="caption">
(#fig:flow-img)The basic workflow behind power simulation.
</p>
</div>
<p>Now that we've gone over the programming basics, we are ready to start building a script to simulate power. To keep things simple, we'll simulate power for the simplest possible situation: a one-sample test, with a point null hypothesis of <span class="math inline">\(H_0: \mu = 0\)</span>.</p>
<p>Figure @ref(fig:flow-img) presents the basic workflow.</p>
<div id="simulating-a-dataset" class="section level3" number="1.2.1">
<h3><span class="header-section-number">1.2.1</span> Simulating a dataset</h3>
<p>The first thing to do is to write (and test) a function <code>generate_data()</code> that takes population parameters and sample size info as input and creates simulated data as output using <code>rnorm()</code>.</p>
<p><strong>TASK: write a function <code>generate_data()</code> that takes three arguments as input: <code>eff</code> (the population intercept parameter), <code>nsubj</code> (number of subjects), and <code>sd</code> (the standard deviation, which should default to 1) and generates a table with simulated data using <code>tibble()</code>. The resulting table should have two columns, <code>subj_id</code> and <code>dv</code> (dependent variable; i.e., the result from <code>rnorm()</code>).</strong></p>
<p>To test your function, run the code below and see if the output matches exactly.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>)</span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a><span class="fu">generate_data</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 2
##    subj_id     dv
##      &lt;int&gt;  &lt;dbl&gt;
##  1       1 -0.420
##  2       2  3.05 
##  3       3  2.58 
##  4       4  6.01 
##  5       5  5.70 
##  6       6  8.99 
##  7       7  4.89 
##  8       8  2.90 
##  9       9  1.98 
## 10      10  4.70</code></pre>
<div class="webex-solution">
<button>
Hint
</button>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(????) {</span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a>  <span class="do">## </span><span class="al">TODO</span><span class="do">: something with tibble()</span></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, <span class="at">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">subj_id =</span> <span class="fu">seq_len</span>(nsubj),</span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a>         <span class="at">dv =</span> <span class="fu">rnorm</span>(nsubj, <span class="at">mean =</span> eff, <span class="at">sd =</span> sd))</span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="analyzing-the-data" class="section level3" number="1.2.2">
<h3><span class="header-section-number">1.2.2</span> Analyzing the data</h3>
<p>Unlike conventional statistical techniques (t-test, ANOVA), linear-mixed effects models are estimated iteratively and may not converge, or may yield estimates of covariance matrices that are "singular" (i.e., can be expressed in lower dimensionality). We will track statistics about singularity / nonconvergence in our simulations, but the repeated messages and warnings can be annoying when they are running, so we need to 'suppress' them. Now, for our simple one-sample power simulation we don't have to deal with these, but we are here to learn, so let's create a function that randomly throws warnings (20% of the time) and messages (20% of the time) so we can learn how to deal with them.</p>
<p>We will name this function <code>annoy_user()</code> and will embed it in our analysis function to simulation the messages we will get once we move to linear mixed-effects modeling.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>annoy_user <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>  <span class="do">## randomly throw messages (20%) or warnings (20%) to annoy the user</span></span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>  <span class="do">## like a linear mixed-effects model</span></span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span>) <span class="co"># roll a five-sided die...</span></span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="sc">==</span> <span class="dv">1</span><span class="dt">L</span>) {</span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;Winter is coming.&quot;</span>)</span>
<span id="cb55-7"><a href="#cb55-7" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (x <span class="sc">==</span> <span class="dv">2</span><span class="dt">L</span>) {</span>
<span id="cb55-8"><a href="#cb55-8" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Approaching the singularity.&quot;</span>)</span>
<span id="cb55-9"><a href="#cb55-9" tabindex="-1"></a>  } <span class="co"># otherwise do nothing</span></span>
<span id="cb55-10"><a href="#cb55-10" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>) <span class="do">## return NULL invisibly</span></span>
<span id="cb55-11"><a href="#cb55-11" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we're ready to write our analysis function. We'll include <code>annoy_user()</code> as part of this function.</p>
<p><strong>TASK: use the starter code below to develop your analysis function for a one-sample test (hint: <code>t.test()</code>). The function should return the full 'data object' output from the t-test function.</strong></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a>  <span class="fu">annoy_user</span>()</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a>  <span class="do">## </span><span class="al">TODO</span><span class="do"> add in your analysis here</span></span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>)</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a><span class="fu">generate_data</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a>  <span class="fu">analyze_data</span>()</span></code></pre></div>
<pre><code>## 
##  One Sample t-test
## 
## data:  pull(dat, dv)
## t = -0.78487, df = 9, p-value = 0.4527
## alternative hypothesis: true mean is not equal to 0
## 95 percent confidence interval:
##  -1.1935688  0.5786762
## sample estimates:
##  mean of x 
## -0.3074463</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>  <span class="fu">annoy_user</span>()</span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a>  dat <span class="sc">|&gt;</span></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>    <span class="fu">pull</span>(dv) <span class="sc">|&gt;</span></span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a>    <span class="fu">t.test</span>()</span>
<span id="cb59-6"><a href="#cb59-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that <code>dat |&gt; pull(dv)</code> is the tidyverse way of extracting a column from a data frame.</p>
</div>
<div id="trapping" class="section level4" number="1.2.2.1">
<h4><span class="header-section-number">1.2.2.1</span> Handling warnings and messages</h4>
<p>OK, if we run <code>generate_data() |&gt; analyze_data()</code> a bunch of times, it's going to occasionally give us bothersome warnings and messages.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, \(.x) <span class="fu">generate_data</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">analyze_data</span>())</span></code></pre></div>
<pre><code>## Warning in annoy_user(): Winter is coming.</code></pre>
<pre><code>## Approaching the singularity.</code></pre>
<pre><code>## Warning in annoy_user(): Winter is coming.
## Warning in annoy_user(): Winter is coming.
## Warning in annoy_user(): Winter is coming.
## Warning in annoy_user(): Winter is coming.</code></pre>
<pre><code>## Approaching the singularity.</code></pre>
<p>We have two options here: we can <em>trap</em> them if we want to react in some way when they occur; or, we can <em>suppress</em> them so that they don't clutter up the output when the model is running. Since there are ways to check convergence / singularity after the fact, we'll opt for suppression. Fortunately R has the functions <code>suppressMessages()</code> and <code>suppressWarnings()</code>, and all we have to do is wrap them around the part of the code that is generating the side effects. So, our final analysis function will be as follows.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(</span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a>    <span class="fu">suppressMessages</span>({</span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>      <span class="fu">annoy_user</span>()</span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>    }))</span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a>  </span>
<span id="cb65-7"><a href="#cb65-7" tabindex="-1"></a>  dat <span class="sc">|&gt;</span></span>
<span id="cb65-8"><a href="#cb65-8" tabindex="-1"></a>    <span class="fu">pull</span>(dv) <span class="sc">|&gt;</span></span>
<span id="cb65-9"><a href="#cb65-9" tabindex="-1"></a>    <span class="fu">t.test</span>()</span>
<span id="cb65-10"><a href="#cb65-10" tabindex="-1"></a>}</span></code></pre></div>
<p>Let's try it again.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, \(.x) <span class="fu">generate_data</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">analyze_data</span>())</span></code></pre></div>
<p>For future reference, in cases where you would want to trap an error/message/warning, you would use the <code>tryCatch()</code> function instead. See <a href="https://adv-r.hadley.nz/conditions.html" class="uri">https://adv-r.hadley.nz/conditions.html</a> if you want a deep dive into the topic of condition handling.</p>
</div>
</div>
<div id="extract" class="section level3" number="1.2.3">
<h3><span class="header-section-number">1.2.3</span> Extracting statistics</h3>
<p>The output of <code>t.test()</code> gives us a data object, but it would be better if we could extract all the relevant stats in the form of a table. We want a function that takes a statistical data object (or fitted model object, <code>mobj</code>) and return a table with statistical information. This is where <code>broom::tidy()</code> comes to the rescue.</p>
<p>Unfortunately this function won't work for linear mixed-effects models, so we'll have to extract what we need in other ways when we get there. But we'll just use <code>broom::tidy()</code> for now.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>extract_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(mobj) {</span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>  mobj <span class="sc">|&gt;</span></span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a>    broom<span class="sc">::</span><span class="fu">tidy</span>()</span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a>}</span></code></pre></div>
<p>We call <code>tidy()</code> using <code>broom::tidy()</code> because we didn't load the package. Generally if you just need a single package function it's a good idea not to load it, to avoid possible namespace clashes.</p>
</div>
<div id="wrapping-it-all-in-a-single-function" class="section level3" number="1.2.4">
<h3><span class="header-section-number">1.2.4</span> Wrapping it all in a single function</h3>
<p>Now we've completed the three functions shown in Figure @ref(fig:flow-img), and can string them together.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a><span class="fu">generate_data</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a>  <span class="fu">analyze_data</span>() <span class="sc">|&gt;</span></span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a>  <span class="fu">extract_stats</span>()</span></code></pre></div>
<pre><code>## # A tibble: 1 × 8
##   estimate statistic p.value parameter conf.low conf.high method     alternative
##      &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      
## 1   -0.360     -1.24   0.246         9    -1.01     0.295 One Sampl… two.sided</code></pre>
<p>We want to do this many times. The way we'll approach this is to create a tibble where each row has the generated data, the model object, and the statistics from a single run.</p>
<p>Here's code to create a tibble with <code>run_id</code> (to identify each row) and a list-column <code>dat</code>, each element of which contains simulated data.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>nmc <span class="ot">&lt;-</span> <span class="dv">20</span><span class="dt">L</span> <span class="co"># number of Monte Carlo runs</span></span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc),</span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a>                 <span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(<span class="dv">0</span>, <span class="dv">10</span>)))</span></code></pre></div>
<p><strong>TASK: Update the code above to add two additional rows, <code>mobj</code> (a list-column) which has the result of applying <code>analyze_data()</code> to each generated dataset, and <code>stats</code> (a list-column) which has the result of applying <code>extract_stats()</code> to each element <code>mobj</code>.</strong></p>
<p>The table <code>result</code> should look as follows.</p>
<pre><code>## # A tibble: 20 × 4
##    run_id dat               mobj    stats           
##     &lt;int&gt; &lt;list&gt;            &lt;list&gt;  &lt;list&gt;          
##  1      1 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  2      2 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  3      3 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  4      4 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  5      5 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  6      6 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  7      7 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  8      8 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
##  9      9 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 10     10 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 11     11 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 12     12 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 13     13 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 14     14 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 15     15 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 16     16 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 17     17 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 18     18 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 19     19 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;
## 20     20 &lt;tibble [10 × 2]&gt; &lt;htest&gt; &lt;tibble [1 × 8]&gt;</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a>nmc <span class="ot">&lt;-</span> <span class="dv">20</span><span class="dt">L</span> <span class="co"># number of Monte Carlo runs</span></span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc),</span>
<span id="cb72-4"><a href="#cb72-4" tabindex="-1"></a>                 <span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(<span class="dv">0</span>, <span class="dv">10</span>)),</span>
<span id="cb72-5"><a href="#cb72-5" tabindex="-1"></a>                 <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb72-6"><a href="#cb72-6" tabindex="-1"></a>                 <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x)))</span></code></pre></div>
</div>
<div id="calculating-power" class="section level4" number="1.2.4.1">
<h4><span class="header-section-number">1.2.4.1</span> Calculating power</h4>
<p>We're getting so close! Now what we need to do is compute power based on the statistics we have calculated (in the <code>stats</code>) column. We can extract these using <code>select()</code> and <code>unnest()</code> like so.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a>result <span class="sc">|&gt;</span></span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a>  <span class="fu">select</span>(run_id, stats) <span class="sc">|&gt;</span></span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a>  <span class="fu">unnest</span>(stats)</span></code></pre></div>
<pre><code>## # A tibble: 20 × 9
##    run_id estimate statistic  p.value parameter conf.low conf.high method       
##     &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;        
##  1      1  -0.338     -1.20  0.260            9   -0.974     0.298 One Sample t…
##  2      2   0.482      1.74  0.115            9   -0.144     1.11  One Sample t…
##  3      3  -0.258     -1.16  0.274            9   -0.761     0.244 One Sample t…
##  4      4  -0.113     -0.491 0.635            9   -0.632     0.407 One Sample t…
##  5      5  -0.447     -1.61  0.143            9   -1.08      0.183 One Sample t…
##  6      6   0.0683     0.209 0.839            9   -0.669     0.806 One Sample t…
##  7      7   0.264      0.810 0.439            9   -0.473     1.00  One Sample t…
##  8      8  -0.622     -1.86  0.0959           9   -1.38      0.135 One Sample t…
##  9      9  -0.0249    -0.106 0.918            9   -0.555     0.505 One Sample t…
## 10     10  -0.139     -0.536 0.605            9   -0.728     0.449 One Sample t…
## 11     11  -0.597     -2.97  0.0157           9   -1.05     -0.143 One Sample t…
## 12     12   0.172      0.533 0.607            9   -0.556     0.899 One Sample t…
## 13     13   0.449      1.28  0.232            9   -0.343     1.24  One Sample t…
## 14     14  -0.218     -1.04  0.324            9   -0.691     0.254 One Sample t…
## 15     15  -0.478     -1.43  0.187            9   -1.23      0.279 One Sample t…
## 16     16  -0.305     -0.808 0.440            9   -1.16      0.549 One Sample t…
## 17     17  -0.627     -1.54  0.158            9   -1.55      0.295 One Sample t…
## 18     18   0.111      0.390 0.706            9   -0.532     0.753 One Sample t…
## 19     19  -0.762     -5.60  0.000335         9   -1.07     -0.454 One Sample t…
## 20     20  -0.122     -0.480 0.642            9   -0.697     0.453 One Sample t…
## # ℹ 1 more variable: alternative &lt;chr&gt;</code></pre>
<p>Now adapt the above code into a function <code>compute_power()</code> that takes a table <code>x</code> (e.g., <code>result</code>) as input along with the <code>alpha</code> level (defaulting to .05) and returns power as a table with <code>nsig</code> (number of significant runs), <code>N</code> (total runs), <code>power</code> (proportion of runs that were significant).</p>
<div class="webex-solution">
<button>
Hint
</button>
<p>You got <code>p.value</code> as a column after unnesting.</p>
<p><code>p.value &lt; alpha</code> will compare each p value to alpha and return <code>TRUE</code> if it is statistically significant, false otherwise.</p>
<p>Do something with <code>summarize()</code> to calculate the number of runs that were significant.</p>
</div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a>compute_power <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a>    <span class="fu">select</span>(stats) <span class="sc">|&gt;</span></span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a>    <span class="fu">unnest</span>(stats) <span class="sc">|&gt;</span></span>
<span id="cb75-5"><a href="#cb75-5" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">nsig =</span> <span class="fu">sum</span>(p.value <span class="sc">&lt;</span> alpha),</span>
<span id="cb75-6"><a href="#cb75-6" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb75-7"><a href="#cb75-7" tabindex="-1"></a>              <span class="at">power =</span> nsig <span class="sc">/</span> N)</span>
<span id="cb75-8"><a href="#cb75-8" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p><strong>TASK: Let's wrap the above code in a function <code>do_once()</code>, that we can run in batch mode as well as interactively, and that goes all the way from from <code>generate_data()</code> to <code>compute_power()</code>. This function should accept as input arguments <code>nmc</code> (number of Monte Carlo runs), <code>eff</code> (effect size), <code>nsubj</code> (number of subjects), <code>sd</code> (standard deviation), and alpha level <code>alpha</code> (defaulting to .05). The function should return the results of <code>compute_power()</code>.</strong></p>
<p>Once complete, test it using the code below. Your output should be identical.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>)</span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a><span class="fu">do_once</span>(<span class="at">nmc =</span> <span class="dv">1000</span>, <span class="at">eff =</span> <span class="dv">0</span>, <span class="at">nsubj =</span> <span class="dv">20</span>, <span class="at">sd =</span> <span class="dv">1</span>, <span class="at">alpha =</span> .<span class="dv">05</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##    nsig     N power
##   &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
## 1    47  1000 0.047</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(nmc, eff, nsubj, sd, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc),</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a>         <span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, sd)),</span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a>         <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a>         <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x))) <span class="sc">|&gt;</span></span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a>    <span class="fu">compute_power</span>(alpha)</span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>OK, one last amendment to <code>do_once()</code>. This function can take a long time to return depending on the number of Monte Carlo runs it needs to complete. So it's useful to send a message to the user so the user knows that the program didn't just hang. Let's do that.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(nmc, eff, nsubj, sd, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;computing power over &quot;</span>, nmc, <span class="st">&quot; runs with eff=&quot;</span>,</span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a>          eff, <span class="st">&quot;; nsubj=&quot;</span>, nsubj, <span class="st">&quot;; sd = &quot;</span>, sd, <span class="st">&quot;; alpha = &quot;</span>, alpha)</span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a>  </span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc),</span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a>         <span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, sd)),</span>
<span id="cb79-8"><a href="#cb79-8" tabindex="-1"></a>         <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb79-9"><a href="#cb79-9" tabindex="-1"></a>         <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x))) <span class="sc">|&gt;</span></span>
<span id="cb79-10"><a href="#cb79-10" tabindex="-1"></a>    <span class="fu">compute_power</span>(alpha)</span>
<span id="cb79-11"><a href="#cb79-11" tabindex="-1"></a>}</span></code></pre></div>
<p>OK, now that you've got this far, you should take a step back and celebrate that you have a function, <code>do_once()</code>, that runs a power simulation given the population parameters, alpha level, and sample size as user input.</p>
</div>
</div>
<div id="calculating-power-curves" class="section level3" number="1.2.5">
<h3><span class="header-section-number">1.2.5</span> Calculating power curves</h3>
<p>So, we've now calculated a power curve for a <em>single parameter setting</em>. But we usually want to calculate a power <em>curve</em> so that we can see how power varies as a function of some parameter (usually, effect size and sample size). How can we do that?</p>
<p>Well, given that we've encapulated the guts of our simulation in a single function, it is a simple matter of just calling that function repeatedly with different inputs and storing the results. Sound familiar?</p>
<p><strong>TASK: Create a tibble with parameter values for <code>eff</code> (effect size) going in 5 steps from 0 to 1. The tibble should have a column <code>pow</code>, which has the results from <code>do_once()</code> called for that value of <code>eff</code> (and with <code>nsubj</code>, <code>sd</code>, and <code>nmc</code> held constant at <code>20</code>, <code>1</code>, and <code>1000</code> respectively).</strong></p>
<p>If you set the seed to 1451 before you run it, then print it out, the resulting table should look like this.</p>
<pre><code>## # A tibble: 5 × 4
##     eff  nsig     N power
##   &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
## 1  0       47  1000 0.047
## 2  0.25   203  1000 0.203
## 3  0.5    576  1000 0.576
## 4  0.75   900  1000 0.9  
## 5  1      987  1000 0.987</code></pre>
<div class="webex-solution">
<button>
Hint about creating a sequence
</button>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">5</span>)</span></code></pre></div>
</div>
<div class="webex-solution">
<button>
Hint: General idea about how the code should look
</button>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a>pow_result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">eff =</span> <span class="fu">seq</span>(???),</span>
<span id="cb82-2"><a href="#cb82-2" tabindex="-1"></a>                     <span class="at">pow =</span> <span class="fu">map</span>(eff, ???)) <span class="sc">|&gt;</span></span>
<span id="cb82-3"><a href="#cb82-3" tabindex="-1"></a>  <span class="fu">unnest</span>(pow)</span>
<span id="cb82-4"><a href="#cb82-4" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" tabindex="-1"></a>pow_result</span></code></pre></div>
</div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a>pow_result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">eff =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">5</span>),</span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a>                     <span class="at">pow =</span> <span class="fu">map</span>(eff, \(.x) <span class="fu">do_once</span>(<span class="dv">1000</span>, .x, <span class="dv">20</span>, <span class="dv">1</span>))) <span class="sc">|&gt;</span></span>
<span id="cb83-3"><a href="#cb83-3" tabindex="-1"></a>  <span class="fu">unnest</span>(pow)</span></code></pre></div>
</div>
</div>
</div>
<div id="the-full-script" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> The full script</h2>
<p>Running power simulations can take a long time. We surely want to save the results when we're done, and probably make it reproducible by setting the seed before calling any functions. But that's it! We now have a self-contained, reproducible script for calculating power.</p>
<div class="webex-solution">
<button>
See the full script
</button>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a><span class="do">## ADD-ON PACKAGES</span></span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;dplyr&quot;</span>)  <span class="co"># select(), mutate(), summarize(), inner_join()</span></span>
<span id="cb84-6"><a href="#cb84-6" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;tibble&quot;</span>) <span class="co"># tibble() [data entry]</span></span>
<span id="cb84-7"><a href="#cb84-7" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;purrr&quot;</span>)  <span class="co"># just for map()</span></span>
<span id="cb84-8"><a href="#cb84-8" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;tidyr&quot;</span>)  <span class="co"># nest(), unnest()</span></span>
<span id="cb84-9"><a href="#cb84-9" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" tabindex="-1"></a>  <span class="fu">requireNamespace</span>(<span class="st">&quot;broom&quot;</span>) <span class="co"># don&#39;t load, just fail if it&#39;s not there</span></span>
<span id="cb84-11"><a href="#cb84-11" tabindex="-1"></a>})</span>
<span id="cb84-12"><a href="#cb84-12" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" tabindex="-1"></a></span>
<span id="cb84-14"><a href="#cb84-14" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb84-15"><a href="#cb84-15" tabindex="-1"></a><span class="do">## MAIN FUNCTIONS</span></span>
<span id="cb84-16"><a href="#cb84-16" tabindex="-1"></a></span>
<span id="cb84-17"><a href="#cb84-17" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, <span class="at">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb84-18"><a href="#cb84-18" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">subj_id =</span> <span class="fu">seq_len</span>(nsubj),</span>
<span id="cb84-19"><a href="#cb84-19" tabindex="-1"></a>         <span class="at">dv =</span> <span class="fu">rnorm</span>(nsubj, <span class="at">mean =</span> eff, <span class="at">sd =</span> sd))</span>
<span id="cb84-20"><a href="#cb84-20" tabindex="-1"></a>}</span>
<span id="cb84-21"><a href="#cb84-21" tabindex="-1"></a></span>
<span id="cb84-22"><a href="#cb84-22" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb84-23"><a href="#cb84-23" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(</span>
<span id="cb84-24"><a href="#cb84-24" tabindex="-1"></a>    <span class="fu">suppressMessages</span>({</span>
<span id="cb84-25"><a href="#cb84-25" tabindex="-1"></a>      <span class="fu">annoy_user</span>()</span>
<span id="cb84-26"><a href="#cb84-26" tabindex="-1"></a>    }))</span>
<span id="cb84-27"><a href="#cb84-27" tabindex="-1"></a>  </span>
<span id="cb84-28"><a href="#cb84-28" tabindex="-1"></a>  dat <span class="sc">|&gt;</span></span>
<span id="cb84-29"><a href="#cb84-29" tabindex="-1"></a>    <span class="fu">pull</span>(dv) <span class="sc">|&gt;</span></span>
<span id="cb84-30"><a href="#cb84-30" tabindex="-1"></a>    <span class="fu">t.test</span>()</span>
<span id="cb84-31"><a href="#cb84-31" tabindex="-1"></a>}</span>
<span id="cb84-32"><a href="#cb84-32" tabindex="-1"></a></span>
<span id="cb84-33"><a href="#cb84-33" tabindex="-1"></a>extract_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(mobj) {</span>
<span id="cb84-34"><a href="#cb84-34" tabindex="-1"></a>  mobj <span class="sc">|&gt;</span></span>
<span id="cb84-35"><a href="#cb84-35" tabindex="-1"></a>    broom<span class="sc">::</span><span class="fu">tidy</span>()</span>
<span id="cb84-36"><a href="#cb84-36" tabindex="-1"></a>}</span>
<span id="cb84-37"><a href="#cb84-37" tabindex="-1"></a></span>
<span id="cb84-38"><a href="#cb84-38" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb84-39"><a href="#cb84-39" tabindex="-1"></a><span class="do">## UTILITY FUNCTIONS</span></span>
<span id="cb84-40"><a href="#cb84-40" tabindex="-1"></a></span>
<span id="cb84-41"><a href="#cb84-41" tabindex="-1"></a>annoy_user <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb84-42"><a href="#cb84-42" tabindex="-1"></a>  <span class="do">## randomly throw messages (20%) or warnings (20%) to annoy the user</span></span>
<span id="cb84-43"><a href="#cb84-43" tabindex="-1"></a>  <span class="do">## like a linear mixed-effects model</span></span>
<span id="cb84-44"><a href="#cb84-44" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span>) <span class="co"># roll a five-sided die...</span></span>
<span id="cb84-45"><a href="#cb84-45" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="sc">==</span> <span class="dv">1</span><span class="dt">L</span>) {</span>
<span id="cb84-46"><a href="#cb84-46" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;Winter is coming.&quot;</span>)</span>
<span id="cb84-47"><a href="#cb84-47" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (x <span class="sc">==</span> <span class="dv">2</span><span class="dt">L</span>) {</span>
<span id="cb84-48"><a href="#cb84-48" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Approaching the singularity.&quot;</span>)</span>
<span id="cb84-49"><a href="#cb84-49" tabindex="-1"></a>  } <span class="co"># otherwise do nothing</span></span>
<span id="cb84-50"><a href="#cb84-50" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>) <span class="do">## return NULL invisibly</span></span>
<span id="cb84-51"><a href="#cb84-51" tabindex="-1"></a>}</span>
<span id="cb84-52"><a href="#cb84-52" tabindex="-1"></a></span>
<span id="cb84-53"><a href="#cb84-53" tabindex="-1"></a>compute_power <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb84-54"><a href="#cb84-54" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb84-55"><a href="#cb84-55" tabindex="-1"></a>    <span class="fu">select</span>(stats) <span class="sc">|&gt;</span></span>
<span id="cb84-56"><a href="#cb84-56" tabindex="-1"></a>    <span class="fu">unnest</span>(stats) <span class="sc">|&gt;</span></span>
<span id="cb84-57"><a href="#cb84-57" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">nsig =</span> <span class="fu">sum</span>(p.value <span class="sc">&lt;</span> alpha),</span>
<span id="cb84-58"><a href="#cb84-58" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb84-59"><a href="#cb84-59" tabindex="-1"></a>              <span class="at">power =</span> nsig <span class="sc">/</span> N)</span>
<span id="cb84-60"><a href="#cb84-60" tabindex="-1"></a>}</span>
<span id="cb84-61"><a href="#cb84-61" tabindex="-1"></a></span>
<span id="cb84-62"><a href="#cb84-62" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(nmc, eff, nsubj, sd, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb84-63"><a href="#cb84-63" tabindex="-1"></a></span>
<span id="cb84-64"><a href="#cb84-64" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;computing power over &quot;</span>, nmc, <span class="st">&quot; runs with eff=&quot;</span>,</span>
<span id="cb84-65"><a href="#cb84-65" tabindex="-1"></a>          eff, <span class="st">&quot;; nsubj=&quot;</span>, nsubj, <span class="st">&quot;; sd = &quot;</span>, sd, <span class="st">&quot;; alpha = &quot;</span>, alpha)</span>
<span id="cb84-66"><a href="#cb84-66" tabindex="-1"></a>  </span>
<span id="cb84-67"><a href="#cb84-67" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc),</span>
<span id="cb84-68"><a href="#cb84-68" tabindex="-1"></a>         <span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, sd)),</span>
<span id="cb84-69"><a href="#cb84-69" tabindex="-1"></a>         <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb84-70"><a href="#cb84-70" tabindex="-1"></a>         <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x))) <span class="sc">|&gt;</span></span>
<span id="cb84-71"><a href="#cb84-71" tabindex="-1"></a>    <span class="fu">compute_power</span>(alpha)</span>
<span id="cb84-72"><a href="#cb84-72" tabindex="-1"></a>}</span>
<span id="cb84-73"><a href="#cb84-73" tabindex="-1"></a></span>
<span id="cb84-74"><a href="#cb84-74" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb84-75"><a href="#cb84-75" tabindex="-1"></a><span class="do">## MAIN PROCEDURE</span></span>
<span id="cb84-76"><a href="#cb84-76" tabindex="-1"></a></span>
<span id="cb84-77"><a href="#cb84-77" tabindex="-1"></a><span class="do">## </span><span class="al">TODO</span><span class="do">: possibly set the seed to something for reproducibility?</span></span>
<span id="cb84-78"><a href="#cb84-78" tabindex="-1"></a></span>
<span id="cb84-79"><a href="#cb84-79" tabindex="-1"></a>pow_result <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">eff =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">5</span>),</span>
<span id="cb84-80"><a href="#cb84-80" tabindex="-1"></a>                     <span class="at">pow =</span> <span class="fu">map</span>(eff, \(.x) <span class="fu">do_once</span>(<span class="dv">1000</span>, .x, <span class="dv">20</span>, <span class="dv">1</span>))) <span class="sc">|&gt;</span></span>
<span id="cb84-81"><a href="#cb84-81" tabindex="-1"></a>  <span class="fu">unnest</span>(pow)</span>
<span id="cb84-82"><a href="#cb84-82" tabindex="-1"></a></span>
<span id="cb84-83"><a href="#cb84-83" tabindex="-1"></a>pow_result</span>
<span id="cb84-84"><a href="#cb84-84" tabindex="-1"></a></span>
<span id="cb84-85"><a href="#cb84-85" tabindex="-1"></a>outfile <span class="ot">&lt;-</span> <span class="st">&quot;simulation-results-one-sample.rds&quot;</span></span>
<span id="cb84-86"><a href="#cb84-86" tabindex="-1"></a></span>
<span id="cb84-87"><a href="#cb84-87" tabindex="-1"></a><span class="fu">saveRDS</span>(pow_result, <span class="at">file =</span> outfile)</span>
<span id="cb84-88"><a href="#cb84-88" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;saved results to &#39;&quot;</span>, outfile, <span class="st">&quot;&#39;&quot;</span>)</span></code></pre></div>
</div>
<!--chapter:end:01_building-blocks.Rmd-->
</div>
</div>
<div id="linear-mixed-effects-modeling" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Linear mixed-effects modeling</h1>
<p>For this first section, we will learn to simulate data corresponding to an experiment with a single, two-level factor (independent variable) that is within-subjects and between-items. Let's imagine that the experiment involves lexical decisions to a set of words (e.g., is "PINT" a word or nonword?), and the dependent variable is response time (in milliseconds), and the independent variable is word type (noun vs verb). We want to treat both subjects and words as random factors (so that we can generalize to the population of events where subjects encounter words).</p>
<p>The general linear model for our study is:</p>
<p><span class="math display">\[Y_{si} = \beta_0 + S_{0s} + I_{0i} + (\beta_1 + S_{1s})X_{i} + e_{si}\]</span></p>
<p>where:</p>
<table>
<colgroup>
<col width="15%" />
<col width="10%" />
<col width="73%" />
</colgroup>
<tbody>
<tr class="odd">
<td><span class="math inline">\(Y_{si}\)</span></td>
<td><code>Y</code></td>
<td>RT for subject <span class="math inline">\(s\)</span> responding to item <span class="math inline">\(i\)</span>;</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\beta_0\)</span></td>
<td><code>mu</code></td>
<td>grand mean;</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(S_{0s}\)</span></td>
<td><code>sri</code></td>
<td>random intercept for subject <span class="math inline">\(s\)</span>;</td>
</tr>
<tr class="even">
<td><span class="math inline">\(I_{0i}\)</span></td>
<td><code>iri</code></td>
<td>random intercept for item <span class="math inline">\(i\)</span>;</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\beta_1\)</span></td>
<td><code>eff</code></td>
<td>fixed effect of word type (slope);</td>
</tr>
<tr class="even">
<td><span class="math inline">\(S_{1s}\)</span></td>
<td><code>srs</code></td>
<td>by-subject random slope;</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(X_{i}\)</span></td>
<td><code>x</code></td>
<td>deviation-coded predictor variable for word type;</td>
</tr>
<tr class="even">
<td><span class="math inline">\(e_{si}\)</span></td>
<td><code>err</code></td>
<td>residual error.</td>
</tr>
</tbody>
</table>
<p><strong>Subjects</strong></p>
<p><span class="math display">\[\left&lt;S_{0i},S_{1i}\right&gt; \sim N(\left&lt;0,0\right&gt;, \Sigma)\]</span></p>
<p>where</p>
<p><span class="math display">\[\Sigma = \left(\begin{array}{cc}{\tau_{00}}^2 &amp; \rho\tau_{00}\tau_{11} \\ \rho\tau_{00}\tau_{11} &amp; {\tau_{11}}^2 \\ \end{array}\right) \]</span></p>
<p><strong>Items</strong></p>
<p><span class="math display">\[I_{0i} \sim N(0, \omega_{00}^2)\]</span></p>
<div id="generate-data" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Generate data</h2>
<div id="set-up-the-environment" class="section level3" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Set up the environment</h3>
<p>If you want to get the same results as everyone else for this exercise, then we all should seed the random number generator with the same value. While we're at it, let's load in the packages we need.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;lme4&quot;</span>)</span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;MASS&quot;</span>) <span class="do">## make sure it&#39;s there but don&#39;t load it</span></span>
<span id="cb85-4"><a href="#cb85-4" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>)</span></code></pre></div>
</div>
<div id="dgp" class="section level3" number="2.1.2">
<h3><span class="header-section-number">2.1.2</span> Define the parameters for the DGP</h3>
<p>Now let's define the parameters for the DGP (data generating process).</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a>nsubj <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of subjects</span></span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a>nitem <span class="ot">&lt;-</span> <span class="dv">50</span>  <span class="co"># must be an even number</span></span>
<span id="cb86-3"><a href="#cb86-3" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="dv">800</span> <span class="co"># grand mean</span></span>
<span id="cb86-5"><a href="#cb86-5" tabindex="-1"></a>eff <span class="ot">&lt;-</span> <span class="dv">80</span> <span class="co"># 80 ms difference</span></span>
<span id="cb86-6"><a href="#cb86-6" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" tabindex="-1"></a>iri_sd <span class="ot">&lt;-</span> <span class="dv">80</span> <span class="co"># by-item random intercept sd (omega_00)</span></span>
<span id="cb86-8"><a href="#cb86-8" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" tabindex="-1"></a><span class="do">## for the by-subjects variance-covariance matrix</span></span>
<span id="cb86-10"><a href="#cb86-10" tabindex="-1"></a>sri_sd <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># by-subject random intercept sd</span></span>
<span id="cb86-11"><a href="#cb86-11" tabindex="-1"></a>srs_sd <span class="ot">&lt;-</span> <span class="dv">40</span> <span class="co"># by-subject random slope sd</span></span>
<span id="cb86-12"><a href="#cb86-12" tabindex="-1"></a>rcor <span class="ot">&lt;-</span> .<span class="dv">2</span> <span class="co"># correlation between intercept and slope</span></span>
<span id="cb86-13"><a href="#cb86-13" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" tabindex="-1"></a>err_sd <span class="ot">&lt;-</span> <span class="dv">200</span> <span class="co"># residual (standard deviation)</span></span></code></pre></div>
<p>You'll create three tables:</p>
<table>
<colgroup>
<col width="14%" />
<col width="85%" />
</colgroup>
<tbody>
<tr class="odd">
<td><code>subjects</code></td>
<td>table of subject data including <code>subj_id</code> and subject random effects</td>
</tr>
<tr class="even">
<td><code>items</code></td>
<td>table of stimulus data including <code>item_id</code> and item random effect</td>
</tr>
<tr class="odd">
<td><code>trials</code></td>
<td>table of trials enumerating encounters between subjects/stimuli</td>
</tr>
</tbody>
</table>
<p>Then you will merge together the information in the three tables, and calculate the response variable according to the model formula above.</p>
</div>
<div id="generate-a-sample-of-stimuli" class="section level3" number="2.1.3">
<h3><span class="header-section-number">2.1.3</span> Generate a sample of stimuli</h3>
<p>Let's randomly generate our 50 items. Create a tibble called <code>item</code> like the one below, where <code>iri</code> are the by-item random intercepts (drawn from a normal distribution with variance <span class="math inline">\(\omega_{00}^2\)</span> = <code>iri_sd^2</code>). Half of the words are of type NOUN (<code>cond</code> = -.5) and half of type VERB (<code>cond</code> = .5).</p>
<pre><code>## # A tibble: 50 × 3
##    item_id  cond     iri
##      &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;
##  1       1  -0.5 -217.  
##  2       2   0.5  -77.9 
##  3       3  -0.5  -96.9 
##  4       4   0.5   40.4 
##  5       5  -0.5   28.0 
##  6       6   0.5  160.  
##  7       7  -0.5   -4.45
##  8       8   0.5  -83.9 
##  9       9  -0.5 -121.  
## 10      10   0.5  -12.1 
## # ℹ 40 more rows</code></pre>
<div class="webex-solution">
<button>
Hint (cond)
</button>
<p><code>rep()</code></p>
</div>
<div class="webex-solution">
<button>
Hint (iri)
</button>
<p><code>rnorm(nitem, ???, ????...)</code></p>
</div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a>items <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">item_id =</span> <span class="dv">1</span><span class="sc">:</span>nitem,</span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a>                <span class="at">cond =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, .<span class="dv">5</span>), <span class="at">times =</span> nitem <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb88-3"><a href="#cb88-3" tabindex="-1"></a>                <span class="at">iri =</span> <span class="fu">rnorm</span>(nitem, <span class="dv">0</span>, <span class="at">sd =</span> iri_sd))</span></code></pre></div>
</div>
</div>
<div id="generate-a-sample-of-subjects" class="section level3" number="2.1.4">
<h3><span class="header-section-number">2.1.4</span> Generate a sample of subjects</h3>
<p>To generate the by-subject random effects, you will need to generate data from a <em>bivariate normal distribution</em>. To do this, we will use the function <code>MASS::mvrnorm()</code>.</p>
<div class="warning">
<p>Do not run <code>library("MASS")</code> just to get this one function, because <code>MASS</code> has a function <code>select()</code> that will overwrite the tidyverse version. Since all we want from MASS is the <code>mvrnorm()</code> function, we can just access it directly by the <code>pkgname::function</code> syntax, i.e., <code>MASS::mvrnorm()</code>.</p>
</div>
<p>Here is an example of how to use <code>MASS::mvrnorm()</code> to randomly generate correlated data (with <span class="math inline">\(r = -.6\)</span>) for a simple bivariate case. In this example, the variances of each of the two variables is defined as 1, such that the covariance becomes equal to the correlation between the variables.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="do">## mx is the variance-covariance matrix</span></span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a>mx <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span>.<span class="dv">6</span>),</span>
<span id="cb89-3"><a href="#cb89-3" tabindex="-1"></a>            <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">6</span>, <span class="dv">1</span>))</span>
<span id="cb89-4"><a href="#cb89-4" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" tabindex="-1"></a>biv_data <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1000</span>,</span>
<span id="cb89-6"><a href="#cb89-6" tabindex="-1"></a>                          <span class="at">mu =</span> <span class="fu">c</span>(<span class="at">V1 =</span> <span class="dv">0</span>, <span class="at">V2 =</span> <span class="dv">0</span>),</span>
<span id="cb89-7"><a href="#cb89-7" tabindex="-1"></a>                          <span class="at">Sigma =</span> mx)</span>
<span id="cb89-8"><a href="#cb89-8" tabindex="-1"></a></span>
<span id="cb89-9"><a href="#cb89-9" tabindex="-1"></a><span class="do">## look at biv_data</span></span>
<span id="cb89-10"><a href="#cb89-10" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">as_tibble</span>(biv_data), <span class="fu">aes</span>(V1, V2)) <span class="sc">+</span></span>
<span id="cb89-11"><a href="#cb89-11" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="02_mixed-effects_files/figure-html/unnamed-chunk-5-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Your subjects table should look like this:</p>
<div class="webex-solution">
<button>
Click to reveal full table
</button>
<pre><code>## # A tibble: 100 × 3
##     subj_id      sri      srs
##       &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##   1       1   42.9    25.7   
##   2       2  -15.3   -28.2   
##   3       3  -41.4   -30.3   
##   4       4  -77.1     3.64  
##   5       5  182.      2.48  
##   6       6   24.6   -13.3   
##   7       7    8.92   42.8   
##   8       8 -101.    -37.2   
##   9       9  -96.8   -32.7   
##  10      10  -27.4   -52.6   
##  11      11  -80.8    -9.06  
##  12      12   83.8   -40.3   
##  13      13  134.    -18.9   
##  14      14 -130.    132.    
##  15      15  -59.2    -8.42  
##  16      16 -127.     12.5   
##  17      17    8.91  -15.3   
##  18      18  -26.8   -19.0   
##  19      19   48.0    39.5   
##  20      20   35.6    28.5   
##  21      21 -199.    -32.9   
##  22      22  -41.1    -9.77  
##  23      23  -29.9     1.02  
##  24      24   12.0   -24.0   
##  25      25   20.5     0.0251
##  26      26   -0.207  47.9   
##  27      27  -13.7   -77.8   
##  28      28 -154.     31.5   
##  29      29  -59.6    67.7   
##  30      30  -50.6   -27.6   
##  31      31  125.      9.51  
##  32      32  111.     13.4   
##  33      33  -27.0    71.7   
##  34      34 -140.     -7.69  
##  35      35  -31.0    18.4   
##  36      36 -185.     31.4   
##  37      37   12.8   -65.8   
##  38      38  -39.7   -51.6   
##  39      39  -93.9    76.3   
##  40      40  -63.9   -12.5   
##  41      41   68.6    -3.47  
##  42      42  -91.9   -31.8   
##  43      43 -143.     53.9   
##  44      44   44.6    48.0   
##  45      45    5.72   24.2   
##  46      46   51.3   101.    
##  47      47 -176.    -47.8   
##  48      48  -54.0   -23.8   
##  49      49   26.8    32.3   
##  50      50   20.4    -9.41  
##  51      51  122.     -2.03  
##  52      52 -111.    -16.1   
##  53      53  266.     16.4   
##  54      54  -42.1    -6.37  
##  55      55   -3.47  -30.1   
##  56      56   94.9    18.0   
##  57      57  -26.9   -19.9   
##  58      58  154.     43.0   
##  59      59  110.    -18.9   
##  60      60 -167.    -14.9   
##  61      61 -255.     -1.70  
##  62      62   95.9   -28.8   
##  63      63  211.    -78.7   
##  64      64  -40.7   102.    
##  65      65 -174.     -1.30  
##  66      66   42.3    11.0   
##  67      67 -120.    -94.1   
##  68      68 -173.     10.0   
##  69      69 -239.     -7.33  
##  70      70   28.8   -29.9   
##  71      71  107.     13.1   
##  72      72 -114.     -3.12  
##  73      73 -114.     20.7   
##  74      74  -23.5   -29.4   
##  75      75  -77.5    23.9   
##  76      76  160.     78.6   
##  77      77 -139.     40.6   
##  78      78   88.2    31.3   
##  79      79   -2.36  -24.1   
##  80      80    6.12    6.91  
##  81      81  -10.8   -47.2   
##  82      82   97.5    48.6   
##  83      83   38.4     5.61  
##  84      84    7.07  -42.2   
##  85      85   81.2    17.9   
##  86      86   52.8    80.4   
##  87      87  -78.4    16.8   
##  88      88 -116.     36.9   
##  89      89  -88.6    18.4   
##  90      90  -36.9   -12.9   
##  91      91 -100.    -21.8   
##  92      92 -114.    -18.9   
##  93      93   25.9   -45.2   
##  94      94  173.     52.7   
##  95      95   18.0   -68.1   
##  96      96 -112.     43.9   
##  97      97   20.9    -2.86  
##  98      98  169.     -2.79  
##  99      99 -101.     -3.88  
## 100     100  106.    -27.6</code></pre>
</div>
<div class="webex-solution">
<button>
Hint 1
</button>
<p>recall that:</p>
<table>
<tbody>
<tr class="odd">
<td><code>sri_sd</code></td>
<td>by-subject random intercept standard deviation</td>
</tr>
<tr class="even">
<td><code>srs_sd</code></td>
<td>by-subject random slope standard deviation</td>
</tr>
<tr class="odd">
<td><code>r</code></td>
<td>correlation between intercept and slope</td>
</tr>
</tbody>
</table>
</div>
<div class="webex-solution">
<button>
Hint 2 (covariance)
</button>
<pre><code>covariance = r * sri_sd * srs_sd</code></pre>
</div>
<div class="webex-solution">
<button>
Hint 3 (building a matrix)
</button>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" tabindex="-1"></a><span class="do">## bind together rows</span></span>
<span id="cb92-2"><a href="#cb92-2" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb92-3"><a href="#cb92-3" tabindex="-1"></a>  <span class="fu">c</span>(sri_sd<span class="sc">^</span><span class="dv">2</span>,            r <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd),</span>
<span id="cb92-4"><a href="#cb92-4" tabindex="-1"></a>  <span class="fu">c</span>(r <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd,            srs_sd<span class="sc">^</span><span class="dv">2</span>)  )</span>
<span id="cb92-5"><a href="#cb92-5" tabindex="-1"></a></span>
<span id="cb92-6"><a href="#cb92-6" tabindex="-1"></a><span class="do">## see also `matrix()`</span></span></code></pre></div>
</div>
<div class="webex-solution">
<button>
Hint 4: (matrix to tibble)
</button>
<p><code>as_tibble(mx)</code></p>
</div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a>mx <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(sri_sd<span class="sc">^</span><span class="dv">2</span>,               rcor <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd),</span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>            <span class="fu">c</span>(rcor <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd, srs_sd<span class="sc">^</span><span class="dv">2</span>)) <span class="co"># look at it</span></span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" tabindex="-1"></a>by_subj_rfx <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(nsubj,</span>
<span id="cb93-5"><a href="#cb93-5" tabindex="-1"></a>                             <span class="at">mu =</span> <span class="fu">c</span>(<span class="at">sri =</span> <span class="dv">0</span>, <span class="at">srs =</span> <span class="dv">0</span>),</span>
<span id="cb93-6"><a href="#cb93-6" tabindex="-1"></a>                             <span class="at">Sigma =</span> mx)</span>
<span id="cb93-7"><a href="#cb93-7" tabindex="-1"></a></span>
<span id="cb93-8"><a href="#cb93-8" tabindex="-1"></a>subjects <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(by_subj_rfx) <span class="sc">|&gt;</span></span>
<span id="cb93-9"><a href="#cb93-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">subj_id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb93-10"><a href="#cb93-10" tabindex="-1"></a>  <span class="fu">select</span>(subj_id, <span class="fu">everything</span>())</span></code></pre></div>
</div>
</div>
<div id="generate-a-sample-of-encounters-trials" class="section level3" number="2.1.5">
<h3><span class="header-section-number">2.1.5</span> Generate a sample of encounters (trials)</h3>
<p>Each trial is an <em>encounter</em> between a particular subject and stimulus. In this experiment, each subject will see each stimulus. Generate a table <code>trials</code> that lists the encounters in the experiments. Note: each participant encounters each stimulus item once. Use the <code>cross_join()</code> function to create all possible encounters.</p>
<p>Now apply this example to generate the table below, where <code>err</code> is the residual term, drawn from <span class="math inline">\(N \sim \left(0, \sigma^2\right)\)</span>, where <span class="math inline">\(\sigma\)</span> is <code>err_sd</code>.</p>
<pre><code>## # A tibble: 5,000 × 3
##    subj_id item_id    err
##      &lt;int&gt;   &lt;int&gt;  &lt;dbl&gt;
##  1       1       1  -64.3
##  2       1       2  585. 
##  3       1       3  127. 
##  4       1       4  182. 
##  5       1       5  -47.6
##  6       1       6   22.0
##  7       1       7 -265. 
##  8       1       8  604. 
##  9       1       9  249. 
## 10       1      10 -147. 
## # ℹ 4,990 more rows</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="fu">cross_join</span>(subjects <span class="sc">|&gt;</span> <span class="fu">select</span>(subj_id),</span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a>                     items <span class="sc">|&gt;</span> <span class="fu">select</span>(item_id)) <span class="sc">|&gt;</span></span>
<span id="cb95-3"><a href="#cb95-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">err =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> nsubj <span class="sc">*</span> nitem,</span>
<span id="cb95-4"><a href="#cb95-4" tabindex="-1"></a>                     <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> err_sd))  </span></code></pre></div>
</div>
</div>
<div id="join-subjects-items-and-trials" class="section level3" number="2.1.6">
<h3><span class="header-section-number">2.1.6</span> Join <code>subjects</code>, <code>items</code>, and <code>trials</code></h3>
<p>Merge the information in <code>subjects</code>, <code>items</code>, and <code>trials</code> to create the full dataset <code>dat</code>, which looks like this:</p>
<pre><code>## # A tibble: 5,000 × 7
##    subj_id item_id   sri     iri   srs  cond    err
##      &lt;int&gt;   &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1       1       1  42.9 -217.    25.7  -0.5  -64.3
##  2       1       2  42.9  -77.9   25.7   0.5  585. 
##  3       1       3  42.9  -96.9   25.7  -0.5  127. 
##  4       1       4  42.9   40.4   25.7   0.5  182. 
##  5       1       5  42.9   28.0   25.7  -0.5  -47.6
##  6       1       6  42.9  160.    25.7   0.5   22.0
##  7       1       7  42.9   -4.45  25.7  -0.5 -265. 
##  8       1       8  42.9  -83.9   25.7   0.5  604. 
##  9       1       9  42.9 -121.    25.7  -0.5  249. 
## 10       1      10  42.9  -12.1   25.7   0.5 -147. 
## # ℹ 4,990 more rows</code></pre>
<p>Note: this is the full <strong>decomposition table</strong> for this model.</p>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a>dat_sim <span class="ot">&lt;-</span> subjects <span class="sc">|&gt;</span></span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a>  <span class="fu">inner_join</span>(trials, <span class="st">&quot;subj_id&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-3"><a href="#cb97-3" tabindex="-1"></a>  <span class="fu">inner_join</span>(items, <span class="st">&quot;item_id&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-4"><a href="#cb97-4" tabindex="-1"></a>  <span class="fu">arrange</span>(subj_id, item_id) <span class="sc">|&gt;</span></span>
<span id="cb97-5"><a href="#cb97-5" tabindex="-1"></a>  <span class="fu">select</span>(subj_id, item_id, sri, iri, srs, cond, err)</span></code></pre></div>
</div>
</div>
<div id="addy" class="section level3" number="2.1.7">
<h3><span class="header-section-number">2.1.7</span> Create the response variable</h3>
<p>Add the response variable <code>Y</code> to dat according to the model formula:</p>
<p><span class="math display">\[Y_{si} = \beta_0 + S_{0s} + I_{0i} + (\beta_1 + S_{1s})X_{i} + e_{si}\]</span></p>
<p>so that the resulting table (<code>dat2</code>) looks like this:</p>
<pre><code>## # A tibble: 5,000 × 8
##    subj_id item_id     Y   sri     iri   srs  cond    err
##      &lt;int&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1       1       1  509.  42.9 -217.    25.7  -0.5  -64.3
##  2       1       2 1403.  42.9  -77.9   25.7   0.5  585. 
##  3       1       3  820.  42.9  -96.9   25.7  -0.5  127. 
##  4       1       4 1118.  42.9   40.4   25.7   0.5  182. 
##  5       1       5  770.  42.9   28.0   25.7  -0.5  -47.6
##  6       1       6 1077.  42.9  160.    25.7   0.5   22.0
##  7       1       7  520.  42.9   -4.45  25.7  -0.5 -265. 
##  8       1       8 1416.  42.9  -83.9   25.7   0.5  604. 
##  9       1       9  918.  42.9 -121.    25.7  -0.5  249. 
## 10       1      10  737.  42.9  -12.1   25.7   0.5 -147. 
## # ℹ 4,990 more rows</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a>dat_sim2 <span class="ot">&lt;-</span> dat_sim <span class="sc">|&gt;</span></span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Y =</span> mu <span class="sc">+</span> sri <span class="sc">+</span> iri <span class="sc">+</span> (eff <span class="sc">+</span> srs) <span class="sc">*</span> cond <span class="sc">+</span> err) <span class="sc">|&gt;</span></span>
<span id="cb99-3"><a href="#cb99-3" tabindex="-1"></a>  <span class="fu">select</span>(subj_id, item_id, Y, <span class="fu">everything</span>())</span></code></pre></div>
</div>
</div>
<div id="fitting-the-model" class="section level3" number="2.1.8">
<h3><span class="header-section-number">2.1.8</span> Fitting the model</h3>
<p>Now that you have created simulated data, estimate the model using <code>lme4::lmer()</code>, and run <code>summary()</code>.</p>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" tabindex="-1"></a>mod_sim <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Y <span class="sc">~</span> cond <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> cond <span class="sc">|</span> subj_id) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> item_id),</span>
<span id="cb100-2"><a href="#cb100-2" tabindex="-1"></a>                dat_sim2)</span>
<span id="cb100-3"><a href="#cb100-3" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" tabindex="-1"></a><span class="fu">summary</span>(mod_sim, <span class="at">corr =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: Y ~ cond + (1 + cond | subj_id) + (1 | item_id)
##    Data: dat_sim2
## 
## REML criterion at convergence: 67628.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.7640 -0.6570 -0.0054  0.6561  3.2214 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  subj_id  (Intercept) 10331.8  101.65       
##           cond          996.5   31.57   0.13
##  item_id  (Intercept)  7655.8   87.50       
##  Residual             40295.6  200.74       
## Number of obs: 5000, groups:  subj_id, 100; item_id, 50
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)   784.73      16.26  48.252
## cond           76.01      25.59   2.971</code></pre>
</div>
<p>Now see if you can identify the data generating parameters in the output of <code>summary()</code>.</p>
<p>First, try to find <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span>.</p>
<div class="webex-solution">
<button>
Solution (fixed effects)
</button>
<table>
<thead>
<tr class="header">
<th align="left">parameter</th>
<th align="left">variable</th>
<th align="right">input</th>
<th align="right">estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\hat{\beta}_0\)</span></td>
<td align="left"><code>mu</code></td>
<td align="right">800</td>
<td align="right">784.729</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\hat{\beta}_1\)</span></td>
<td align="left"><code>eff</code></td>
<td align="right">80</td>
<td align="right">76.005</td>
</tr>
</tbody>
</table>
</div>
<p>Now try to find estimates of random effects parameters <span class="math inline">\(\tau_{00}\)</span>, <span class="math inline">\(\tau_{11}\)</span>, <span class="math inline">\(\rho\)</span>, <span class="math inline">\(\omega_{00}\)</span>, and <span class="math inline">\(\sigma\)</span>.</p>
<div class="webex-solution">
<button>
Solution (random effects)
</button>
<table>
<thead>
<tr class="header">
<th align="left">parameter</th>
<th align="left">variable</th>
<th align="right">input</th>
<th align="right">estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\hat{\tau}_{00}\)</span></td>
<td align="left"><code>sri_sd</code></td>
<td align="right">100.0</td>
<td align="right">101.646</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\hat{\tau}_{11}\)</span></td>
<td align="left"><code>srs_sd</code></td>
<td align="right">40.0</td>
<td align="right">31.567</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\hat{\rho}\)</span></td>
<td align="left"><code>rcor</code></td>
<td align="right">0.2</td>
<td align="right">0.130</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\hat{\omega}_{00}\)</span></td>
<td align="left"><code>iri_sd</code></td>
<td align="right">80.0</td>
<td align="right">87.498</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\hat{\sigma}\)</span></td>
<td align="left"><code>err_sd</code></td>
<td align="right">200.0</td>
<td align="right">200.738</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="building-the-simulation-script" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Building the simulation script</h2>
<p>Now that we've learned to simulated data with crossed random factors of subjects and stimuli, let's build a script to run the simulation. You might want to start a fresh R script for this (and load in tidyverse + lme4 at the top).</p>
<div id="wrapping-the-code-into-generate_data" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Wrapping the code into <code>generate_data()</code></h3>
<p>Now wrap the code you created from section @ref(dgp) to @ref(addy) into a single function <code>generate_data()</code> that takes the arguments: <code>eff</code> (effect size), <code>nsubj</code> (number of subjects), <code>nitem</code> (number of items), and then all the remaining DGP paramemters in this order: <code>mu</code>, <code>iri_sd</code>, <code>sri_sd</code>, <code>srs_sd</code>, <code>rcor</code>, and <code>err_sd</code>.</p>
<p>The code should return a table with columns <code>subj_id</code>, <code>item_id</code>, <code>cond</code>, and <code>Y</code>.</p>
<p>Here is 'starter' code that does nothing.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, nitem,</span>
<span id="cb102-2"><a href="#cb102-2" tabindex="-1"></a>                          mu, iri_sd, sri_sd,</span>
<span id="cb102-3"><a href="#cb102-3" tabindex="-1"></a>                          srs_sd, rcor, err_sd) {</span>
<span id="cb102-4"><a href="#cb102-4" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" tabindex="-1"></a>  <span class="do">## 1. </span><span class="al">TODO</span><span class="do"> generate sample of stimuli</span></span>
<span id="cb102-6"><a href="#cb102-6" tabindex="-1"></a>  <span class="do">## 2. </span><span class="al">TODO</span><span class="do"> generate sample of subjects</span></span>
<span id="cb102-7"><a href="#cb102-7" tabindex="-1"></a>  <span class="do">## 3. </span><span class="al">TODO</span><span class="do"> generate trials, adding in error</span></span>
<span id="cb102-8"><a href="#cb102-8" tabindex="-1"></a>  <span class="do">## 4. </span><span class="al">TODO</span><span class="do"> join the three tables together</span></span>
<span id="cb102-9"><a href="#cb102-9" tabindex="-1"></a>  <span class="do">## 5. </span><span class="al">TODO</span><span class="do"> create the response variable</span></span>
<span id="cb102-10"><a href="#cb102-10" tabindex="-1"></a></span>
<span id="cb102-11"><a href="#cb102-11" tabindex="-1"></a>  <span class="do">## </span><span class="al">TODO</span><span class="do"> replace this placeholder table with your result</span></span>
<span id="cb102-12"><a href="#cb102-12" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">subj_id =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb102-13"><a href="#cb102-13" tabindex="-1"></a>         <span class="at">item_id =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb102-14"><a href="#cb102-14" tabindex="-1"></a>         <span class="at">cond =</span> <span class="fu">double</span>(<span class="dv">0</span>),</span>
<span id="cb102-15"><a href="#cb102-15" tabindex="-1"></a>         <span class="at">Y =</span> <span class="fu">double</span>(<span class="dv">0</span>))</span>
<span id="cb102-16"><a href="#cb102-16" tabindex="-1"></a>}</span>
<span id="cb102-17"><a href="#cb102-17" tabindex="-1"></a></span>
<span id="cb102-18"><a href="#cb102-18" tabindex="-1"></a><span class="do">## test it out</span></span>
<span id="cb102-19"><a href="#cb102-19" tabindex="-1"></a><span class="fu">generate_data</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">10</span>,</span>
<span id="cb102-20"><a href="#cb102-20" tabindex="-1"></a>              <span class="at">mu =</span> <span class="dv">800</span>, <span class="at">iri_sd =</span> <span class="dv">80</span>, <span class="at">sri_sd =</span> <span class="dv">100</span>,</span>
<span id="cb102-21"><a href="#cb102-21" tabindex="-1"></a>              <span class="at">srs_sd =</span> <span class="dv">40</span>, <span class="at">rcor =</span> .<span class="dv">2</span>, <span class="at">err_sd =</span> <span class="dv">200</span>)</span></code></pre></div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, nitem,</span>
<span id="cb103-2"><a href="#cb103-2" tabindex="-1"></a>                          mu, iri_sd, sri_sd,</span>
<span id="cb103-3"><a href="#cb103-3" tabindex="-1"></a>                          srs_sd, rcor, err_sd) {</span>
<span id="cb103-4"><a href="#cb103-4" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" tabindex="-1"></a>  <span class="do">## 1. generate sample of stimuli</span></span>
<span id="cb103-6"><a href="#cb103-6" tabindex="-1"></a>  items <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">item_id =</span> <span class="dv">1</span><span class="sc">:</span>nitem,</span>
<span id="cb103-7"><a href="#cb103-7" tabindex="-1"></a>                  <span class="at">cond =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, .<span class="dv">5</span>), <span class="at">times =</span> nitem <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb103-8"><a href="#cb103-8" tabindex="-1"></a>                  <span class="at">iri =</span> <span class="fu">rnorm</span>(nitem, <span class="dv">0</span>, <span class="at">sd =</span> iri_sd))</span>
<span id="cb103-9"><a href="#cb103-9" tabindex="-1"></a>  </span>
<span id="cb103-10"><a href="#cb103-10" tabindex="-1"></a>  <span class="do">## 2. generate sample of subjects</span></span>
<span id="cb103-11"><a href="#cb103-11" tabindex="-1"></a>  mx <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(sri_sd<span class="sc">^</span><span class="dv">2</span>,               rcor <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd),</span>
<span id="cb103-12"><a href="#cb103-12" tabindex="-1"></a>              <span class="fu">c</span>(rcor <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd, srs_sd<span class="sc">^</span><span class="dv">2</span>)) <span class="co"># look at it</span></span>
<span id="cb103-13"><a href="#cb103-13" tabindex="-1"></a></span>
<span id="cb103-14"><a href="#cb103-14" tabindex="-1"></a>  by_subj_rfx <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(nsubj,</span>
<span id="cb103-15"><a href="#cb103-15" tabindex="-1"></a>                               <span class="at">mu =</span> <span class="fu">c</span>(<span class="at">sri =</span> <span class="dv">0</span>, <span class="at">srs =</span> <span class="dv">0</span>),</span>
<span id="cb103-16"><a href="#cb103-16" tabindex="-1"></a>                               <span class="at">Sigma =</span> mx)</span>
<span id="cb103-17"><a href="#cb103-17" tabindex="-1"></a></span>
<span id="cb103-18"><a href="#cb103-18" tabindex="-1"></a>  subjects <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(by_subj_rfx) <span class="sc">|&gt;</span></span>
<span id="cb103-19"><a href="#cb103-19" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">subj_id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb103-20"><a href="#cb103-20" tabindex="-1"></a>    <span class="fu">select</span>(subj_id, <span class="fu">everything</span>())</span>
<span id="cb103-21"><a href="#cb103-21" tabindex="-1"></a>  </span>
<span id="cb103-22"><a href="#cb103-22" tabindex="-1"></a>  <span class="do">## 3. generate trials, adding in error</span></span>
<span id="cb103-23"><a href="#cb103-23" tabindex="-1"></a>  trials <span class="ot">&lt;-</span> <span class="fu">cross_join</span>(subjects <span class="sc">|&gt;</span> <span class="fu">select</span>(subj_id),</span>
<span id="cb103-24"><a href="#cb103-24" tabindex="-1"></a>                       items <span class="sc">|&gt;</span> <span class="fu">select</span>(item_id)) <span class="sc">|&gt;</span></span>
<span id="cb103-25"><a href="#cb103-25" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">err =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> nsubj <span class="sc">*</span> nitem,</span>
<span id="cb103-26"><a href="#cb103-26" tabindex="-1"></a>                       <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> err_sd))</span>
<span id="cb103-27"><a href="#cb103-27" tabindex="-1"></a>  </span>
<span id="cb103-28"><a href="#cb103-28" tabindex="-1"></a>  <span class="do">## 4. join the three tables together, AND</span></span>
<span id="cb103-29"><a href="#cb103-29" tabindex="-1"></a>  <span class="do">## 5. create the response variable</span></span>
<span id="cb103-30"><a href="#cb103-30" tabindex="-1"></a>  subjects <span class="sc">|&gt;</span></span>
<span id="cb103-31"><a href="#cb103-31" tabindex="-1"></a>    <span class="fu">inner_join</span>(trials, <span class="st">&quot;subj_id&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb103-32"><a href="#cb103-32" tabindex="-1"></a>    <span class="fu">inner_join</span>(items, <span class="st">&quot;item_id&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb103-33"><a href="#cb103-33" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Y =</span> mu <span class="sc">+</span> sri <span class="sc">+</span> iri <span class="sc">+</span> (eff <span class="sc">+</span> srs) <span class="sc">*</span> cond <span class="sc">+</span> err) <span class="sc">|&gt;</span></span>
<span id="cb103-34"><a href="#cb103-34" tabindex="-1"></a>    <span class="fu">select</span>(subj_id, item_id, cond, Y)</span>
<span id="cb103-35"><a href="#cb103-35" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="re-write-analyze_data" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Re-write <code>analyze_data()</code></h3>
<p>Now let's re-write our <code>analyze_data()</code> function for this design.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb104-2"><a href="#cb104-2" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>( <span class="co"># ignore non-convergence</span></span>
<span id="cb104-3"><a href="#cb104-3" tabindex="-1"></a>    <span class="fu">suppressMessages</span>({ <span class="co"># ignore &#39;singular fit&#39;</span></span>
<span id="cb104-4"><a href="#cb104-4" tabindex="-1"></a>      <span class="do">## </span><span class="al">TODO</span><span class="do">: something with lmer()</span></span>
<span id="cb104-5"><a href="#cb104-5" tabindex="-1"></a>    }))</span>
<span id="cb104-6"><a href="#cb104-6" tabindex="-1"></a>}</span></code></pre></div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb105-2"><a href="#cb105-2" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>( <span class="co"># ignore non-convergence</span></span>
<span id="cb105-3"><a href="#cb105-3" tabindex="-1"></a>    <span class="fu">suppressMessages</span>({ <span class="co"># ignore &#39;singular fit&#39;</span></span>
<span id="cb105-4"><a href="#cb105-4" tabindex="-1"></a>      <span class="fu">lmer</span>(Y <span class="sc">~</span> cond <span class="sc">+</span> (cond <span class="sc">|</span> subj_id) <span class="sc">+</span></span>
<span id="cb105-5"><a href="#cb105-5" tabindex="-1"></a>             (<span class="dv">1</span> <span class="sc">|</span> item_id), <span class="at">data =</span> dat)</span>
<span id="cb105-6"><a href="#cb105-6" tabindex="-1"></a>    }))</span>
<span id="cb105-7"><a href="#cb105-7" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="re-write-extract_stats" class="section level3" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> Re-write <code>extract_stats()</code></h3>
<p>In the last section, we wrote the function <code>extract_stats()</code> to pull out statistics from a t-test object.</p>
<p>Let's change it so it gets information about the regression coefficient (fixed effect) for <code>cond</code>. Unfortunately we can't use <code>broom::tidy()</code> here.</p>
<p>Recall that we have suppressed any messages about singularity or nonconvergence. We want to track this information, so we'll get it from the fitted model object.</p>
<p>To find out whether a fit is singular, we can use the function <code>isSingular()</code>. Figuring out whether a model has converged is more complicate. Use the helper function <code>check_converged()</code> below. This takes a fitted model object as input and returns <code>TRUE</code> if the model converged, <code>FALSE</code> otherwise.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" tabindex="-1"></a>check_converged <span class="ot">&lt;-</span> <span class="cf">function</span>(mobj) {</span>
<span id="cb106-2"><a href="#cb106-2" tabindex="-1"></a>  <span class="do">## warning: this is kind of a hack!</span></span>
<span id="cb106-3"><a href="#cb106-3" tabindex="-1"></a>  <span class="do">## see also performance::check_convergence()</span></span>
<span id="cb106-4"><a href="#cb106-4" tabindex="-1"></a>  sm <span class="ot">&lt;-</span> <span class="fu">summary</span>(mobj)</span>
<span id="cb106-5"><a href="#cb106-5" tabindex="-1"></a>  <span class="fu">is.null</span>(sm<span class="sc">$</span>optinfo<span class="sc">$</span>conv<span class="sc">$</span>lme4<span class="sc">$</span>messages)</span>
<span id="cb106-6"><a href="#cb106-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Use <code>fixef()</code> to get the fixed effects estimates from the model.</p>
<p>You'll also want to get the standard error for the fixed effects. You can do so using the code</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(mobj)))</span></code></pre></div>
<p>where <code>mobj</code> is the name of the fitted model object. We'll then calculate a <span class="math inline">\(p\)</span> value based on Wald <span class="math inline">\(z\)</span>, which is just the estimate divided by its standard error, and then treated as a <span class="math inline">\(z\)</span> statistic (from the standard normal distribution). If we call that statistic <code>tval</code>, you can get the <span class="math inline">\(p\)</span> value using <code>2 * (1 - pnorm(abs(tval)))</code>.</p>
<p><strong>TASK: Write a new version of <code>extract_stats()</code> that takes <code>mobj</code>, a fitted model object as input, and returns a tibble with columns <code>sing</code> (<code>TRUE</code> for singular fit, <code>FALSE</code> otherwise), <code>conv</code> (<code>TRUE</code> for converged, <code>FALSE</code> otherwise), <code>estimate</code> with the fixed effect estimate for the effect of <code>cond</code>, <code>stderr</code> for the standard error, <code>tval</code> for the <span class="math inline">\(t\)</span>-value, and <code>pval</code> for the <span class="math inline">\(p\)</span>-value.</strong></p>
<p>Test it by running it out on <code>mod_sim</code> which you estimated above. You should get the results like the following.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" tabindex="-1"></a><span class="fu">extract_stats</span>(mod_sim)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   sing  conv  estimate stderr  tval    pval
##   &lt;lgl&gt; &lt;lgl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
## 1 FALSE TRUE      76.0   25.6  2.97 0.00297</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" tabindex="-1"></a>extract_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(mobj) {</span>
<span id="cb110-2"><a href="#cb110-2" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">sing =</span> <span class="fu">isSingular</span>(mobj),</span>
<span id="cb110-3"><a href="#cb110-3" tabindex="-1"></a>         <span class="at">conv =</span> <span class="fu">check_converged</span>(mobj),</span>
<span id="cb110-4"><a href="#cb110-4" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">fixef</span>(mobj)[<span class="st">&quot;cond&quot;</span>],</span>
<span id="cb110-5"><a href="#cb110-5" tabindex="-1"></a>         <span class="at">stderr =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(mobj)))[<span class="st">&quot;cond&quot;</span>],</span>
<span id="cb110-6"><a href="#cb110-6" tabindex="-1"></a>         <span class="at">tval =</span> estimate <span class="sc">/</span> stderr,</span>
<span id="cb110-7"><a href="#cb110-7" tabindex="-1"></a>         <span class="at">pval =</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(tval))))</span>
<span id="cb110-8"><a href="#cb110-8" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>Now we have completed the three main functions for a single run as shown in @ref(fig:flow-img). We can try them out like this:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" tabindex="-1"></a><span class="fu">generate_data</span>(<span class="at">eff =</span> <span class="dv">0</span>, <span class="at">nsubj =</span> <span class="dv">20</span>, <span class="at">nitem =</span> <span class="dv">10</span>,</span>
<span id="cb111-2"><a href="#cb111-2" tabindex="-1"></a>              <span class="at">mu =</span> <span class="dv">800</span>, <span class="at">iri_sd =</span> <span class="dv">80</span>, <span class="at">sri_sd =</span> <span class="dv">100</span>,</span>
<span id="cb111-3"><a href="#cb111-3" tabindex="-1"></a>              <span class="at">srs_sd =</span> <span class="dv">40</span>, <span class="at">rcor =</span> .<span class="dv">2</span>, <span class="at">err_sd =</span> <span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb111-4"><a href="#cb111-4" tabindex="-1"></a>  <span class="fu">analyze_data</span>() <span class="sc">|&gt;</span></span>
<span id="cb111-5"><a href="#cb111-5" tabindex="-1"></a>  <span class="fu">extract_stats</span>()</span></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   sing  conv  estimate stderr   tval  pval
##   &lt;lgl&gt; &lt;lgl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1 FALSE TRUE     -55.9   63.0 -0.888 0.375</code></pre>
<p>The next step will be to wrap this in a function.</p>
</div>
<div id="re-write-do_once" class="section level3" number="2.2.4">
<h3><span class="header-section-number">2.2.4</span> Re-write <code>do_once()</code></h3>
<p>The function <code>do_once()</code> performs all three functions (generates the data, analyzes it, and subtracts the results). It needs some minor changes to work with the parameters of the new DGP.</p>
<p>Now let's re-write <code>do_once()</code>. Here's starter code from the function we created for the one-sample t-test context. You'll need to change its arguments to match <code>generate_data()</code> as well as the arguments passed to <code>generate_data()</code> via <code>map()</code>. It's also a good idea to update the <code>message()</code> it prints for the user.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(nmc, eff, nsubj, sd, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb113-2"><a href="#cb113-2" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;computing power over &quot;</span>, nmc, <span class="st">&quot; runs with eff=&quot;</span>,</span>
<span id="cb113-4"><a href="#cb113-4" tabindex="-1"></a>          eff, <span class="st">&quot;; nsubj=&quot;</span>, nsubj, <span class="st">&quot;; sd = &quot;</span>, sd, <span class="st">&quot;; alpha = &quot;</span>, alpha)</span>
<span id="cb113-5"><a href="#cb113-5" tabindex="-1"></a>  </span>
<span id="cb113-6"><a href="#cb113-6" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc),</span>
<span id="cb113-7"><a href="#cb113-7" tabindex="-1"></a>         <span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, sd)),</span>
<span id="cb113-8"><a href="#cb113-8" tabindex="-1"></a>         <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb113-9"><a href="#cb113-9" tabindex="-1"></a>         <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x)))</span>
<span id="cb113-10"><a href="#cb113-10" tabindex="-1"></a>}</span></code></pre></div>
<p>It doesn't do everything we need (yet) because in the end we'll want to <code>compute_power()</code> and return that instead. But we'll save that for later.</p>
<p>Try it out with the code below. Results should look as follows.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>)</span>
<span id="cb114-2"><a href="#cb114-2" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" tabindex="-1"></a>do_test <span class="ot">&lt;-</span> <span class="fu">do_once</span>(<span class="at">eff =</span> <span class="dv">0</span>, <span class="at">nsubj =</span> <span class="dv">20</span>, <span class="at">nitem =</span> <span class="dv">10</span>, <span class="at">nmc =</span> <span class="dv">20</span>,</span>
<span id="cb114-4"><a href="#cb114-4" tabindex="-1"></a>                   <span class="at">mu =</span> <span class="dv">800</span>, <span class="at">iri_sd =</span> <span class="dv">80</span>, <span class="at">sri_sd =</span> <span class="dv">100</span>,</span>
<span id="cb114-5"><a href="#cb114-5" tabindex="-1"></a>                   <span class="at">srs_sd =</span> <span class="dv">40</span>, <span class="at">rcor =</span> .<span class="dv">2</span>, <span class="at">err_sd =</span> <span class="dv">200</span>)</span></code></pre></div>
<pre><code>## computing stats over 20 runs for nsubj=20; nitem=10; eff=0</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" tabindex="-1"></a>do_test</span></code></pre></div>
<pre><code>## # A tibble: 20 × 4
##    run_id dat                mobj      stats           
##     &lt;int&gt; &lt;list&gt;             &lt;list&gt;    &lt;list&gt;          
##  1      1 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  2      2 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  3      3 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  4      4 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  5      5 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  6      6 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  7      7 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  8      8 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
##  9      9 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 10     10 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 11     11 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 12     12 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 13     13 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 14     14 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 15     15 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 16     16 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 17     17 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 18     18 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 19     19 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;
## 20     20 &lt;tibble [200 × 4]&gt; &lt;lmerMod&gt; &lt;tibble [1 × 6]&gt;</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, nitem, nmc,</span>
<span id="cb118-2"><a href="#cb118-2" tabindex="-1"></a>                   mu, iri_sd, sri_sd,</span>
<span id="cb118-3"><a href="#cb118-3" tabindex="-1"></a>                   srs_sd, rcor, err_sd) {</span>
<span id="cb118-4"><a href="#cb118-4" tabindex="-1"></a>  <span class="do">## generate, analyze, and extract for a single parameter setting</span></span>
<span id="cb118-5"><a href="#cb118-5" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;computing stats over &quot;</span>, nmc,</span>
<span id="cb118-6"><a href="#cb118-6" tabindex="-1"></a>          <span class="st">&quot; runs for nsubj=&quot;</span>, nsubj, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb118-7"><a href="#cb118-7" tabindex="-1"></a>          <span class="st">&quot;nitem=&quot;</span>, nitem, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb118-8"><a href="#cb118-8" tabindex="-1"></a>          <span class="st">&quot;eff=&quot;</span>, eff)</span>
<span id="cb118-9"><a href="#cb118-9" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc)) <span class="sc">|&gt;</span></span>
<span id="cb118-10"><a href="#cb118-10" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, nitem,</span>
<span id="cb118-11"><a href="#cb118-11" tabindex="-1"></a>                                                 mu, iri_sd, sri_sd,</span>
<span id="cb118-12"><a href="#cb118-12" tabindex="-1"></a>                                                 srs_sd, rcor, err_sd)),</span>
<span id="cb118-13"><a href="#cb118-13" tabindex="-1"></a>           <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb118-14"><a href="#cb118-14" tabindex="-1"></a>           <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x)))</span>
<span id="cb118-15"><a href="#cb118-15" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="update-do_once-to-return-statistics" class="section level3" number="2.2.5">
<h3><span class="header-section-number">2.2.5</span> Update <code>do_once()</code> to return statistics</h3>
<p>We're nearly there. Our <code>do_once()</code> function returns the raw data from the run, but what we'd really like instead are the power statistics. So we'll need to re-write <code>compute_power()</code> and then include that in <code>do_once()</code>. We stored the results of the (old) <code>do_once()</code> in <code>do_test</code>, which is useful for testing it out.</p>
<p>Recall that we can get all the stats into a single table like so.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" tabindex="-1"></a>do_test <span class="sc">|&gt;</span></span>
<span id="cb119-2"><a href="#cb119-2" tabindex="-1"></a>  <span class="fu">select</span>(run_id, stats) <span class="sc">|&gt;</span></span>
<span id="cb119-3"><a href="#cb119-3" tabindex="-1"></a>  <span class="fu">unnest</span>(stats)</span></code></pre></div>
<pre><code>## # A tibble: 20 × 7
##    run_id sing  conv  estimate stderr    tval   pval
##     &lt;int&gt; &lt;lgl&gt; &lt;lgl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
##  1      1 TRUE  FALSE    74.7    72.0  1.04   0.300 
##  2      2 TRUE  FALSE    91.5    61.6  1.49   0.137 
##  3      3 TRUE  FALSE    68.6    29.6  2.32   0.0205
##  4      4 FALSE TRUE     -9.17   42.0 -0.218  0.827 
##  5      5 TRUE  FALSE   -36.0    79.1 -0.455  0.649 
##  6      6 TRUE  FALSE   -86.2    37.0 -2.33   0.0199
##  7      7 TRUE  FALSE    -3.02   56.5 -0.0534 0.957 
##  8      8 TRUE  FALSE   -68.8    69.1 -0.995  0.320 
##  9      9 TRUE  FALSE   -11.6    91.9 -0.126  0.900 
## 10     10 FALSE TRUE    128.     77.3  1.66   0.0979
## 11     11 TRUE  FALSE   -12.1    57.5 -0.211  0.833 
## 12     12 FALSE TRUE     33.5    59.5  0.562  0.574 
## 13     13 TRUE  FALSE    58.9    62.4  0.944  0.345 
## 14     14 FALSE TRUE      9.97   66.3  0.150  0.880 
## 15     15 TRUE  FALSE  -127.     51.1 -2.49   0.0128
## 16     16 FALSE TRUE      2.55   66.0  0.0386 0.969 
## 17     17 TRUE  FALSE   115.     60.0  1.91   0.0557
## 18     18 TRUE  FALSE   -28.0    58.5 -0.478  0.633 
## 19     19 TRUE  FALSE    64.5    53.8  1.20   0.231 
## 20     20 TRUE  FALSE   -55.5    63.7 -0.872  0.383</code></pre>
<p><strong>TASK: Write <code>compute_power()</code> to provide not only power information, but also reports the proportion of runs that had a 'singularity' message (<code>n_sing</code>) or that did not converge (<code>n_nonconv</code>).</strong></p>
<p>Results should look like so.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" tabindex="-1"></a>compute_power <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb121-2"><a href="#cb121-2" tabindex="-1"></a>  <span class="do">## after completing all the Monte Carlo runs for a set,</span></span>
<span id="cb121-3"><a href="#cb121-3" tabindex="-1"></a>  <span class="do">## calculate statistics</span></span>
<span id="cb121-4"><a href="#cb121-4" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb121-5"><a href="#cb121-5" tabindex="-1"></a>    <span class="fu">select</span>(run_id, stats) <span class="sc">|&gt;</span></span>
<span id="cb121-6"><a href="#cb121-6" tabindex="-1"></a>    <span class="fu">unnest</span>(stats) <span class="sc">|&gt;</span></span>
<span id="cb121-7"><a href="#cb121-7" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">n_sing =</span> <span class="fu">sum</span>(sing),</span>
<span id="cb121-8"><a href="#cb121-8" tabindex="-1"></a>              <span class="at">n_nonconv =</span> <span class="fu">sum</span>(<span class="sc">!</span>conv), </span>
<span id="cb121-9"><a href="#cb121-9" tabindex="-1"></a>              <span class="at">n_sig =</span> <span class="fu">sum</span>(pval <span class="sc">&lt;</span> alpha),</span>
<span id="cb121-10"><a href="#cb121-10" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb121-11"><a href="#cb121-11" tabindex="-1"></a>              <span class="at">power =</span> n_sig <span class="sc">/</span> N)</span>
<span id="cb121-12"><a href="#cb121-12" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" tabindex="-1"></a>do_test <span class="sc">|&gt;</span></span>
<span id="cb122-2"><a href="#cb122-2" tabindex="-1"></a>  <span class="fu">compute_power</span>()</span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   n_sing n_nonconv n_sig     N power
##    &lt;int&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
## 1     15        15     3    20  0.15</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" tabindex="-1"></a>compute_power <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb124-2"><a href="#cb124-2" tabindex="-1"></a>  <span class="do">## after completing all the Monte Carlo runs for a set,</span></span>
<span id="cb124-3"><a href="#cb124-3" tabindex="-1"></a>  <span class="do">## calculate statistics</span></span>
<span id="cb124-4"><a href="#cb124-4" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb124-5"><a href="#cb124-5" tabindex="-1"></a>    <span class="fu">select</span>(run_id, stats) <span class="sc">|&gt;</span></span>
<span id="cb124-6"><a href="#cb124-6" tabindex="-1"></a>    <span class="fu">unnest</span>(stats) <span class="sc">|&gt;</span></span>
<span id="cb124-7"><a href="#cb124-7" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">n_sing =</span> <span class="fu">sum</span>(sing),</span>
<span id="cb124-8"><a href="#cb124-8" tabindex="-1"></a>              <span class="at">n_nonconv =</span> <span class="fu">sum</span>(<span class="sc">!</span>conv), </span>
<span id="cb124-9"><a href="#cb124-9" tabindex="-1"></a>              <span class="at">n_sig =</span> <span class="fu">sum</span>(pval <span class="sc">&lt;</span> alpha),</span>
<span id="cb124-10"><a href="#cb124-10" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb124-11"><a href="#cb124-11" tabindex="-1"></a>              <span class="at">power =</span> n_sig <span class="sc">/</span> N)</span>
<span id="cb124-12"><a href="#cb124-12" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p><strong>TASK: update <code>do_once()</code> so that it ends with <code>compute_power()</code>.</strong></p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, nitem, nmc,</span>
<span id="cb125-2"><a href="#cb125-2" tabindex="-1"></a>                   mu, iri_sd, sri_sd,</span>
<span id="cb125-3"><a href="#cb125-3" tabindex="-1"></a>                   srs_sd, rcor, err_sd) {</span>
<span id="cb125-4"><a href="#cb125-4" tabindex="-1"></a>  <span class="do">## generate, analyze, and extract for a single parameter setting</span></span>
<span id="cb125-5"><a href="#cb125-5" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;computing stats over &quot;</span>, nmc,</span>
<span id="cb125-6"><a href="#cb125-6" tabindex="-1"></a>          <span class="st">&quot; runs for nsubj=&quot;</span>, nsubj, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb125-7"><a href="#cb125-7" tabindex="-1"></a>          <span class="st">&quot;nitem=&quot;</span>, nitem, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb125-8"><a href="#cb125-8" tabindex="-1"></a>          <span class="st">&quot;eff=&quot;</span>, eff)</span>
<span id="cb125-9"><a href="#cb125-9" tabindex="-1"></a>  </span>
<span id="cb125-10"><a href="#cb125-10" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc)) <span class="sc">|&gt;</span></span>
<span id="cb125-11"><a href="#cb125-11" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, nitem,</span>
<span id="cb125-12"><a href="#cb125-12" tabindex="-1"></a>                                                 mu, iri_sd, sri_sd,</span>
<span id="cb125-13"><a href="#cb125-13" tabindex="-1"></a>                                                 srs_sd, rcor, err_sd)),</span>
<span id="cb125-14"><a href="#cb125-14" tabindex="-1"></a>           <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb125-15"><a href="#cb125-15" tabindex="-1"></a>           <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x))) <span class="sc">|&gt;</span></span>
<span id="cb125-16"><a href="#cb125-16" tabindex="-1"></a>  <span class="fu">compute_power</span>()</span>
<span id="cb125-17"><a href="#cb125-17" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>)</span>
<span id="cb126-2"><a href="#cb126-2" tabindex="-1"></a></span>
<span id="cb126-3"><a href="#cb126-3" tabindex="-1"></a><span class="fu">do_once</span>(<span class="at">eff =</span> <span class="dv">0</span>, <span class="at">nsubj =</span> <span class="dv">20</span>, <span class="at">nitem =</span> <span class="dv">10</span>, <span class="at">nmc =</span> <span class="dv">20</span>,</span>
<span id="cb126-4"><a href="#cb126-4" tabindex="-1"></a>                   <span class="at">mu =</span> <span class="dv">800</span>, <span class="at">iri_sd =</span> <span class="dv">80</span>, <span class="at">sri_sd =</span> <span class="dv">100</span>,</span>
<span id="cb126-5"><a href="#cb126-5" tabindex="-1"></a>                   <span class="at">srs_sd =</span> <span class="dv">40</span>, <span class="at">rcor =</span> .<span class="dv">2</span>, <span class="at">err_sd =</span> <span class="dv">200</span>)</span></code></pre></div>
<pre><code>## computing stats over 20 runs for nsubj=20; nitem=10; eff=0</code></pre>
<pre><code>## # A tibble: 1 × 5
##   n_sing n_nonconv n_sig     N power
##    &lt;int&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
## 1     15        15     3    20  0.15</code></pre>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, nitem, nmc,</span>
<span id="cb129-2"><a href="#cb129-2" tabindex="-1"></a>                   mu, iri_sd, sri_sd,</span>
<span id="cb129-3"><a href="#cb129-3" tabindex="-1"></a>                   srs_sd, rcor, err_sd) {</span>
<span id="cb129-4"><a href="#cb129-4" tabindex="-1"></a>  <span class="do">## generate, analyze, and extract for a single parameter setting</span></span>
<span id="cb129-5"><a href="#cb129-5" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;computing stats over &quot;</span>, nmc,</span>
<span id="cb129-6"><a href="#cb129-6" tabindex="-1"></a>          <span class="st">&quot; runs for nsubj=&quot;</span>, nsubj, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb129-7"><a href="#cb129-7" tabindex="-1"></a>          <span class="st">&quot;nitem=&quot;</span>, nitem, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb129-8"><a href="#cb129-8" tabindex="-1"></a>          <span class="st">&quot;eff=&quot;</span>, eff)</span>
<span id="cb129-9"><a href="#cb129-9" tabindex="-1"></a>  </span>
<span id="cb129-10"><a href="#cb129-10" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc)) <span class="sc">|&gt;</span></span>
<span id="cb129-11"><a href="#cb129-11" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, nitem,</span>
<span id="cb129-12"><a href="#cb129-12" tabindex="-1"></a>                                                 mu, iri_sd, sri_sd,</span>
<span id="cb129-13"><a href="#cb129-13" tabindex="-1"></a>                                                 srs_sd, rcor, err_sd)),</span>
<span id="cb129-14"><a href="#cb129-14" tabindex="-1"></a>           <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb129-15"><a href="#cb129-15" tabindex="-1"></a>           <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x))) <span class="sc">|&gt;</span></span>
<span id="cb129-16"><a href="#cb129-16" tabindex="-1"></a>  <span class="fu">compute_power</span>()</span>
<span id="cb129-17"><a href="#cb129-17" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="main-code" class="section level3" number="2.2.6">
<h3><span class="header-section-number">2.2.6</span> Main code</h3>
<p>Now that we've re-written all of the functions, let's add the following lines to create a fully reproducible script that we can run in batch mode.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>) <span class="co"># for deterministic output</span></span>
<span id="cb130-2"><a href="#cb130-2" tabindex="-1"></a></span>
<span id="cb130-3"><a href="#cb130-3" tabindex="-1"></a><span class="do">## determine effect sizes, nsubj, nitem, and nmc from the command line</span></span>
<span id="cb130-4"><a href="#cb130-4" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)) <span class="sc">!=</span> <span class="dv">6</span><span class="dt">L</span>) {</span>
<span id="cb130-5"><a href="#cb130-5" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;need to specify &#39;nmc&#39; &#39;eff_a&#39; &#39;eff_b&#39; &#39;steps&#39; &#39;nsubj&#39; &#39;nitem&#39;&quot;</span>)</span>
<span id="cb130-6"><a href="#cb130-6" tabindex="-1"></a>}</span>
<span id="cb130-7"><a href="#cb130-7" tabindex="-1"></a></span>
<span id="cb130-8"><a href="#cb130-8" tabindex="-1"></a>nmc <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">1</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()   <span class="co"># no. Monte Carlo runs</span></span>
<span id="cb130-9"><a href="#cb130-9" tabindex="-1"></a>eff_a <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">2</span>] <span class="sc">|&gt;</span> <span class="fu">as.double</span>()  <span class="co"># smallest effect size</span></span>
<span id="cb130-10"><a href="#cb130-10" tabindex="-1"></a>eff_b <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">3</span>] <span class="sc">|&gt;</span> <span class="fu">as.double</span>()  <span class="co"># largest effect size</span></span>
<span id="cb130-11"><a href="#cb130-11" tabindex="-1"></a>steps <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">4</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>() <span class="co"># number of steps</span></span>
<span id="cb130-12"><a href="#cb130-12" tabindex="-1"></a>nsubj <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">5</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb130-13"><a href="#cb130-13" tabindex="-1"></a>nitem <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">6</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb130-14"><a href="#cb130-14" tabindex="-1"></a></span>
<span id="cb130-15"><a href="#cb130-15" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="fu">seq_len</span>(steps),</span>
<span id="cb130-16"><a href="#cb130-16" tabindex="-1"></a>                 <span class="at">eff =</span> <span class="fu">seq</span>(eff_a, eff_b, <span class="at">length.out =</span> steps))</span>
<span id="cb130-17"><a href="#cb130-17" tabindex="-1"></a></span>
<span id="cb130-18"><a href="#cb130-18" tabindex="-1"></a>allsets <span class="ot">&lt;-</span> params <span class="sc">|&gt;</span></span>
<span id="cb130-19"><a href="#cb130-19" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(eff,</span>
<span id="cb130-20"><a href="#cb130-20" tabindex="-1"></a>                      \(.x) <span class="fu">do_once</span>(.x, <span class="at">nsubj =</span> nsubj, <span class="at">nitem =</span> nitem, <span class="at">nmc =</span> nmc,</span>
<span id="cb130-21"><a href="#cb130-21" tabindex="-1"></a>                                    <span class="at">mu =</span> <span class="dv">800</span>, <span class="at">iri_sd =</span> <span class="dv">80</span>, <span class="at">sri_sd =</span> <span class="dv">100</span>,</span>
<span id="cb130-22"><a href="#cb130-22" tabindex="-1"></a>                                    <span class="at">srs_sd =</span> <span class="dv">40</span>, <span class="at">rcor =</span> .<span class="dv">2</span>, <span class="at">err_sd =</span> <span class="dv">200</span>)))</span>
<span id="cb130-23"><a href="#cb130-23" tabindex="-1"></a>                      </span>
<span id="cb130-24"><a href="#cb130-24" tabindex="-1"></a>pow_result <span class="ot">&lt;-</span> allsets <span class="sc">|&gt;</span></span>
<span id="cb130-25"><a href="#cb130-25" tabindex="-1"></a>  <span class="fu">unnest</span>(result)</span>
<span id="cb130-26"><a href="#cb130-26" tabindex="-1"></a></span>
<span id="cb130-27"><a href="#cb130-27" tabindex="-1"></a>pow_result</span>
<span id="cb130-28"><a href="#cb130-28" tabindex="-1"></a></span>
<span id="cb130-29"><a href="#cb130-29" tabindex="-1"></a>outfile <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;sim-results_%d_%0.2f_%0.2f_%d_%d_%d.rds&quot;</span>,</span>
<span id="cb130-30"><a href="#cb130-30" tabindex="-1"></a>                   nmc, eff_a, eff_b, steps, nsubj, nitem)</span>
<span id="cb130-31"><a href="#cb130-31" tabindex="-1"></a></span>
<span id="cb130-32"><a href="#cb130-32" tabindex="-1"></a><span class="fu">saveRDS</span>(pow_result, outfile)</span>
<span id="cb130-33"><a href="#cb130-33" tabindex="-1"></a></span>
<span id="cb130-34"><a href="#cb130-34" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;results saved to &#39;&quot;</span>, outfile, <span class="st">&quot;&#39;&quot;</span>)</span></code></pre></div>
</div>
<div id="the-full-script-1" class="section level3" number="2.2.7">
<h3><span class="header-section-number">2.2.7</span> The full script</h3>
<div class='webex-solution'>
<button>
Click here to see the full script
</button>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb131-2"><a href="#cb131-2" tabindex="-1"></a><span class="do">## ADD-ON PACKAGES</span></span>
<span id="cb131-3"><a href="#cb131-3" tabindex="-1"></a></span>
<span id="cb131-4"><a href="#cb131-4" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb131-5"><a href="#cb131-5" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;dplyr&quot;</span>)</span>
<span id="cb131-6"><a href="#cb131-6" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;tibble&quot;</span>)</span>
<span id="cb131-7"><a href="#cb131-7" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;purrr&quot;</span>)</span>
<span id="cb131-8"><a href="#cb131-8" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;tidyr&quot;</span>)</span>
<span id="cb131-9"><a href="#cb131-9" tabindex="-1"></a></span>
<span id="cb131-10"><a href="#cb131-10" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;lme4&quot;</span>)</span>
<span id="cb131-11"><a href="#cb131-11" tabindex="-1"></a>})</span>
<span id="cb131-12"><a href="#cb131-12" tabindex="-1"></a></span>
<span id="cb131-13"><a href="#cb131-13" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;MASS&quot;</span>) <span class="co"># make sure it&#39;s there but don&#39;t load it</span></span>
<span id="cb131-14"><a href="#cb131-14" tabindex="-1"></a></span>
<span id="cb131-15"><a href="#cb131-15" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb131-16"><a href="#cb131-16" tabindex="-1"></a><span class="do">## CUSTOM FUNCTIONS</span></span>
<span id="cb131-17"><a href="#cb131-17" tabindex="-1"></a></span>
<span id="cb131-18"><a href="#cb131-18" tabindex="-1"></a>generate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, nitem,</span>
<span id="cb131-19"><a href="#cb131-19" tabindex="-1"></a>                          mu, iri_sd, sri_sd,</span>
<span id="cb131-20"><a href="#cb131-20" tabindex="-1"></a>                          srs_sd, rcor, err_sd) {</span>
<span id="cb131-21"><a href="#cb131-21" tabindex="-1"></a></span>
<span id="cb131-22"><a href="#cb131-22" tabindex="-1"></a>  <span class="do">## 1. generate sample of stimuli</span></span>
<span id="cb131-23"><a href="#cb131-23" tabindex="-1"></a>  items <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">item_id =</span> <span class="dv">1</span><span class="sc">:</span>nitem,</span>
<span id="cb131-24"><a href="#cb131-24" tabindex="-1"></a>                  <span class="at">cond =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, .<span class="dv">5</span>), <span class="at">times =</span> nitem <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb131-25"><a href="#cb131-25" tabindex="-1"></a>                  <span class="at">iri =</span> <span class="fu">rnorm</span>(nitem, <span class="dv">0</span>, <span class="at">sd =</span> iri_sd))</span>
<span id="cb131-26"><a href="#cb131-26" tabindex="-1"></a>  </span>
<span id="cb131-27"><a href="#cb131-27" tabindex="-1"></a>  <span class="do">## 2. generate sample of subjects</span></span>
<span id="cb131-28"><a href="#cb131-28" tabindex="-1"></a>  mx <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(sri_sd<span class="sc">^</span><span class="dv">2</span>,               rcor <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd),</span>
<span id="cb131-29"><a href="#cb131-29" tabindex="-1"></a>              <span class="fu">c</span>(rcor <span class="sc">*</span> sri_sd <span class="sc">*</span> srs_sd, srs_sd<span class="sc">^</span><span class="dv">2</span>)) <span class="co"># look at it</span></span>
<span id="cb131-30"><a href="#cb131-30" tabindex="-1"></a></span>
<span id="cb131-31"><a href="#cb131-31" tabindex="-1"></a>  by_subj_rfx <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(nsubj,</span>
<span id="cb131-32"><a href="#cb131-32" tabindex="-1"></a>                               <span class="at">mu =</span> <span class="fu">c</span>(<span class="at">sri =</span> <span class="dv">0</span>, <span class="at">srs =</span> <span class="dv">0</span>),</span>
<span id="cb131-33"><a href="#cb131-33" tabindex="-1"></a>                               <span class="at">Sigma =</span> mx)</span>
<span id="cb131-34"><a href="#cb131-34" tabindex="-1"></a></span>
<span id="cb131-35"><a href="#cb131-35" tabindex="-1"></a>  subjects <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(by_subj_rfx) <span class="sc">|&gt;</span></span>
<span id="cb131-36"><a href="#cb131-36" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">subj_id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb131-37"><a href="#cb131-37" tabindex="-1"></a>    <span class="fu">select</span>(subj_id, <span class="fu">everything</span>())</span>
<span id="cb131-38"><a href="#cb131-38" tabindex="-1"></a>  </span>
<span id="cb131-39"><a href="#cb131-39" tabindex="-1"></a>  <span class="do">## 3. generate trials, adding in error</span></span>
<span id="cb131-40"><a href="#cb131-40" tabindex="-1"></a>  trials <span class="ot">&lt;-</span> <span class="fu">cross_join</span>(subjects <span class="sc">|&gt;</span> <span class="fu">select</span>(subj_id),</span>
<span id="cb131-41"><a href="#cb131-41" tabindex="-1"></a>                       items <span class="sc">|&gt;</span> <span class="fu">select</span>(item_id)) <span class="sc">|&gt;</span></span>
<span id="cb131-42"><a href="#cb131-42" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">err =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> nsubj <span class="sc">*</span> nitem,</span>
<span id="cb131-43"><a href="#cb131-43" tabindex="-1"></a>                       <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> err_sd))</span>
<span id="cb131-44"><a href="#cb131-44" tabindex="-1"></a>  </span>
<span id="cb131-45"><a href="#cb131-45" tabindex="-1"></a>  <span class="do">## 4. join the three tables together, AND</span></span>
<span id="cb131-46"><a href="#cb131-46" tabindex="-1"></a>  <span class="do">## 5. create the response variable</span></span>
<span id="cb131-47"><a href="#cb131-47" tabindex="-1"></a>  subjects <span class="sc">|&gt;</span></span>
<span id="cb131-48"><a href="#cb131-48" tabindex="-1"></a>    <span class="fu">inner_join</span>(trials, <span class="st">&quot;subj_id&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-49"><a href="#cb131-49" tabindex="-1"></a>    <span class="fu">inner_join</span>(items, <span class="st">&quot;item_id&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-50"><a href="#cb131-50" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Y =</span> mu <span class="sc">+</span> sri <span class="sc">+</span> iri <span class="sc">+</span> (eff <span class="sc">+</span> srs) <span class="sc">*</span> cond <span class="sc">+</span> err) <span class="sc">|&gt;</span></span>
<span id="cb131-51"><a href="#cb131-51" tabindex="-1"></a>    <span class="fu">select</span>(subj_id, item_id, cond, Y)</span>
<span id="cb131-52"><a href="#cb131-52" tabindex="-1"></a>}</span>
<span id="cb131-53"><a href="#cb131-53" tabindex="-1"></a></span>
<span id="cb131-54"><a href="#cb131-54" tabindex="-1"></a>analyze_data <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb131-55"><a href="#cb131-55" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>( <span class="co"># ignore non-convergence</span></span>
<span id="cb131-56"><a href="#cb131-56" tabindex="-1"></a>    <span class="fu">suppressMessages</span>({ <span class="co"># ignore &#39;singular fit&#39;</span></span>
<span id="cb131-57"><a href="#cb131-57" tabindex="-1"></a>      <span class="fu">lmer</span>(Y <span class="sc">~</span> cond <span class="sc">+</span> (cond <span class="sc">|</span> subj_id) <span class="sc">+</span></span>
<span id="cb131-58"><a href="#cb131-58" tabindex="-1"></a>             (<span class="dv">1</span> <span class="sc">|</span> item_id), <span class="at">data =</span> dat)</span>
<span id="cb131-59"><a href="#cb131-59" tabindex="-1"></a>    }))</span>
<span id="cb131-60"><a href="#cb131-60" tabindex="-1"></a>}</span>
<span id="cb131-61"><a href="#cb131-61" tabindex="-1"></a></span>
<span id="cb131-62"><a href="#cb131-62" tabindex="-1"></a>extract_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(mobj) {</span>
<span id="cb131-63"><a href="#cb131-63" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">sing =</span> <span class="fu">isSingular</span>(mobj),</span>
<span id="cb131-64"><a href="#cb131-64" tabindex="-1"></a>         <span class="at">conv =</span> <span class="fu">check_converged</span>(mobj),</span>
<span id="cb131-65"><a href="#cb131-65" tabindex="-1"></a>         <span class="at">estimate =</span> <span class="fu">fixef</span>(mobj)[<span class="st">&quot;cond&quot;</span>],</span>
<span id="cb131-66"><a href="#cb131-66" tabindex="-1"></a>         <span class="at">stderr =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(mobj)))[<span class="st">&quot;cond&quot;</span>],</span>
<span id="cb131-67"><a href="#cb131-67" tabindex="-1"></a>         <span class="at">tval =</span> estimate <span class="sc">/</span> stderr,</span>
<span id="cb131-68"><a href="#cb131-68" tabindex="-1"></a>         <span class="at">pval =</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(tval))))</span>
<span id="cb131-69"><a href="#cb131-69" tabindex="-1"></a>}</span>
<span id="cb131-70"><a href="#cb131-70" tabindex="-1"></a></span>
<span id="cb131-71"><a href="#cb131-71" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb131-72"><a href="#cb131-72" tabindex="-1"></a><span class="do">## UTILITY FUNCTIONS</span></span>
<span id="cb131-73"><a href="#cb131-73" tabindex="-1"></a></span>
<span id="cb131-74"><a href="#cb131-74" tabindex="-1"></a>check_converged <span class="ot">&lt;-</span> <span class="cf">function</span>(mobj) {</span>
<span id="cb131-75"><a href="#cb131-75" tabindex="-1"></a>  <span class="do">## warning: this is kind of a hack!</span></span>
<span id="cb131-76"><a href="#cb131-76" tabindex="-1"></a>  <span class="do">## see also performance::check_convergence()</span></span>
<span id="cb131-77"><a href="#cb131-77" tabindex="-1"></a>  sm <span class="ot">&lt;-</span> <span class="fu">summary</span>(mobj)</span>
<span id="cb131-78"><a href="#cb131-78" tabindex="-1"></a>  <span class="fu">is.null</span>(sm<span class="sc">$</span>optinfo<span class="sc">$</span>conv<span class="sc">$</span>lme4<span class="sc">$</span>messages)</span>
<span id="cb131-79"><a href="#cb131-79" tabindex="-1"></a>}</span>
<span id="cb131-80"><a href="#cb131-80" tabindex="-1"></a></span>
<span id="cb131-81"><a href="#cb131-81" tabindex="-1"></a>compute_power <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">alpha =</span> .<span class="dv">05</span>) {</span>
<span id="cb131-82"><a href="#cb131-82" tabindex="-1"></a>  <span class="do">## after completing all the Monte Carlo runs for a set,</span></span>
<span id="cb131-83"><a href="#cb131-83" tabindex="-1"></a>  <span class="do">## calculate statistics</span></span>
<span id="cb131-84"><a href="#cb131-84" tabindex="-1"></a>  x <span class="sc">|&gt;</span></span>
<span id="cb131-85"><a href="#cb131-85" tabindex="-1"></a>    <span class="fu">select</span>(run_id, stats) <span class="sc">|&gt;</span></span>
<span id="cb131-86"><a href="#cb131-86" tabindex="-1"></a>    <span class="fu">unnest</span>(stats) <span class="sc">|&gt;</span></span>
<span id="cb131-87"><a href="#cb131-87" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">n_sing =</span> <span class="fu">sum</span>(sing),</span>
<span id="cb131-88"><a href="#cb131-88" tabindex="-1"></a>              <span class="at">n_nonconv =</span> <span class="fu">sum</span>(<span class="sc">!</span>conv), </span>
<span id="cb131-89"><a href="#cb131-89" tabindex="-1"></a>              <span class="at">n_sig =</span> <span class="fu">sum</span>(pval <span class="sc">&lt;</span> alpha),</span>
<span id="cb131-90"><a href="#cb131-90" tabindex="-1"></a>              <span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb131-91"><a href="#cb131-91" tabindex="-1"></a>              <span class="at">power =</span> n_sig <span class="sc">/</span> N)</span>
<span id="cb131-92"><a href="#cb131-92" tabindex="-1"></a>}</span>
<span id="cb131-93"><a href="#cb131-93" tabindex="-1"></a></span>
<span id="cb131-94"><a href="#cb131-94" tabindex="-1"></a>do_once <span class="ot">&lt;-</span> <span class="cf">function</span>(eff, nsubj, nitem, nmc,</span>
<span id="cb131-95"><a href="#cb131-95" tabindex="-1"></a>                   mu, iri_sd, sri_sd,</span>
<span id="cb131-96"><a href="#cb131-96" tabindex="-1"></a>                   srs_sd, rcor, err_sd) {</span>
<span id="cb131-97"><a href="#cb131-97" tabindex="-1"></a>  <span class="do">## generate, analyze, and extract for a single parameter setting</span></span>
<span id="cb131-98"><a href="#cb131-98" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;computing stats over &quot;</span>, nmc,</span>
<span id="cb131-99"><a href="#cb131-99" tabindex="-1"></a>          <span class="st">&quot; runs for nsubj=&quot;</span>, nsubj, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb131-100"><a href="#cb131-100" tabindex="-1"></a>          <span class="st">&quot;nitem=&quot;</span>, nitem, <span class="st">&quot;; &quot;</span>,</span>
<span id="cb131-101"><a href="#cb131-101" tabindex="-1"></a>          <span class="st">&quot;eff=&quot;</span>, eff)</span>
<span id="cb131-102"><a href="#cb131-102" tabindex="-1"></a>  </span>
<span id="cb131-103"><a href="#cb131-103" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">run_id =</span> <span class="fu">seq_len</span>(nmc)) <span class="sc">|&gt;</span></span>
<span id="cb131-104"><a href="#cb131-104" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dat =</span> <span class="fu">map</span>(run_id, \(.x) <span class="fu">generate_data</span>(eff, nsubj, nitem,</span>
<span id="cb131-105"><a href="#cb131-105" tabindex="-1"></a>                                                 mu, iri_sd, sri_sd,</span>
<span id="cb131-106"><a href="#cb131-106" tabindex="-1"></a>                                                 srs_sd, rcor, err_sd)),</span>
<span id="cb131-107"><a href="#cb131-107" tabindex="-1"></a>           <span class="at">mobj =</span> <span class="fu">map</span>(dat, \(.x) <span class="fu">analyze_data</span>(.x)),</span>
<span id="cb131-108"><a href="#cb131-108" tabindex="-1"></a>           <span class="at">stats =</span> <span class="fu">map</span>(mobj, \(.x) <span class="fu">extract_stats</span>(.x))) <span class="sc">|&gt;</span></span>
<span id="cb131-109"><a href="#cb131-109" tabindex="-1"></a>  <span class="fu">compute_power</span>()</span>
<span id="cb131-110"><a href="#cb131-110" tabindex="-1"></a>}</span>
<span id="cb131-111"><a href="#cb131-111" tabindex="-1"></a></span>
<span id="cb131-112"><a href="#cb131-112" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb131-113"><a href="#cb131-113" tabindex="-1"></a><span class="do">## MAIN CODE STARTS HERE</span></span>
<span id="cb131-114"><a href="#cb131-114" tabindex="-1"></a></span>
<span id="cb131-115"><a href="#cb131-115" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1451</span>) <span class="co"># for deterministic output</span></span>
<span id="cb131-116"><a href="#cb131-116" tabindex="-1"></a></span>
<span id="cb131-117"><a href="#cb131-117" tabindex="-1"></a><span class="do">## determine effect sizes, nsubj, nitem, and nmc from the command line</span></span>
<span id="cb131-118"><a href="#cb131-118" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)) <span class="sc">!=</span> <span class="dv">6</span><span class="dt">L</span>) {</span>
<span id="cb131-119"><a href="#cb131-119" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;need to specify &#39;nmc&#39; &#39;eff_a&#39; &#39;eff_b&#39; &#39;steps&#39; &#39;nsubj&#39; &#39;nitem&#39;&quot;</span>)</span>
<span id="cb131-120"><a href="#cb131-120" tabindex="-1"></a>}</span>
<span id="cb131-121"><a href="#cb131-121" tabindex="-1"></a></span>
<span id="cb131-122"><a href="#cb131-122" tabindex="-1"></a>nmc <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">1</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()   <span class="co"># no. Monte Carlo runs</span></span>
<span id="cb131-123"><a href="#cb131-123" tabindex="-1"></a>eff_a <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">2</span>] <span class="sc">|&gt;</span> <span class="fu">as.double</span>()  <span class="co"># smallest effect size</span></span>
<span id="cb131-124"><a href="#cb131-124" tabindex="-1"></a>eff_b <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">3</span>] <span class="sc">|&gt;</span> <span class="fu">as.double</span>()  <span class="co"># largest effect size</span></span>
<span id="cb131-125"><a href="#cb131-125" tabindex="-1"></a>steps <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">4</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>() <span class="co"># number of steps</span></span>
<span id="cb131-126"><a href="#cb131-126" tabindex="-1"></a>nsubj <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">5</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb131-127"><a href="#cb131-127" tabindex="-1"></a>nitem <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="cn">TRUE</span>)[<span class="dv">6</span>] <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb131-128"><a href="#cb131-128" tabindex="-1"></a></span>
<span id="cb131-129"><a href="#cb131-129" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="fu">seq_len</span>(steps),</span>
<span id="cb131-130"><a href="#cb131-130" tabindex="-1"></a>                 <span class="at">eff =</span> <span class="fu">seq</span>(eff_a, eff_b, <span class="at">length.out =</span> steps))</span>
<span id="cb131-131"><a href="#cb131-131" tabindex="-1"></a></span>
<span id="cb131-132"><a href="#cb131-132" tabindex="-1"></a>allsets <span class="ot">&lt;-</span> params <span class="sc">|&gt;</span></span>
<span id="cb131-133"><a href="#cb131-133" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">map</span>(eff,</span>
<span id="cb131-134"><a href="#cb131-134" tabindex="-1"></a>                      \(.x) <span class="fu">do_once</span>(.x, <span class="at">nsubj =</span> nsubj, <span class="at">nitem =</span> nitem, <span class="at">nmc =</span> nmc,</span>
<span id="cb131-135"><a href="#cb131-135" tabindex="-1"></a>                                    <span class="at">mu =</span> <span class="dv">800</span>, <span class="at">iri_sd =</span> <span class="dv">80</span>, <span class="at">sri_sd =</span> <span class="dv">100</span>,</span>
<span id="cb131-136"><a href="#cb131-136" tabindex="-1"></a>                                    <span class="at">srs_sd =</span> <span class="dv">40</span>, <span class="at">rcor =</span> .<span class="dv">2</span>, <span class="at">err_sd =</span> <span class="dv">200</span>)))</span>
<span id="cb131-137"><a href="#cb131-137" tabindex="-1"></a>                      </span>
<span id="cb131-138"><a href="#cb131-138" tabindex="-1"></a>pow_result <span class="ot">&lt;-</span> allsets <span class="sc">|&gt;</span></span>
<span id="cb131-139"><a href="#cb131-139" tabindex="-1"></a>  <span class="fu">unnest</span>(result)</span>
<span id="cb131-140"><a href="#cb131-140" tabindex="-1"></a></span>
<span id="cb131-141"><a href="#cb131-141" tabindex="-1"></a>pow_result</span>
<span id="cb131-142"><a href="#cb131-142" tabindex="-1"></a></span>
<span id="cb131-143"><a href="#cb131-143" tabindex="-1"></a>outfile <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;sim-results_%d_%0.2f_%0.2f_%d_%d_%d.rds&quot;</span>,</span>
<span id="cb131-144"><a href="#cb131-144" tabindex="-1"></a>                   nmc, eff_a, eff_b, steps, nsubj, nitem)</span>
<span id="cb131-145"><a href="#cb131-145" tabindex="-1"></a></span>
<span id="cb131-146"><a href="#cb131-146" tabindex="-1"></a><span class="fu">saveRDS</span>(pow_result, outfile)</span>
<span id="cb131-147"><a href="#cb131-147" tabindex="-1"></a></span>
<span id="cb131-148"><a href="#cb131-148" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;results saved to &#39;&quot;</span>, outfile, <span class="st">&quot;&#39;&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="running-in-batch-mode" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Running in batch mode</h2>
<p>Now let's run our power simulation.</p>
<p>Save the full script into a file named <code>my-power-script.R</code>.</p>
<p>Go to your operating system's command line (or do so in RStudio), and navigate to the directory where you saved it.</p>
<p>At the command line, type</p>
<pre><code>Rscript my-power-script.R</code></pre>
<p>This should produce an error because you haven't specified any command line arguments.</p>
<pre><code>Error: need to specify &#39;nmc&#39; &#39;eff_a&#39; &#39;eff_b&#39; &#39;steps&#39; &#39;nsubj&#39; &#39;nitem&#39;
Execution halted</code></pre>
<p>Let's try again, putting in arguments in that order.</p>
<pre><code>Rscript my-power-script.R 1000 0 160 5 40 20</code></pre>
<p>It worked!</p>
<pre><code>computing stats over 1000 runs for nsubj=40; nitem=20; eff=0
computing stats over 1000 runs for nsubj=40; nitem=20; eff=40
computing stats over 1000 runs for nsubj=40; nitem=20; eff=80
computing stats over 1000 runs for nsubj=40; nitem=20; eff=120
computing stats over 1000 runs for nsubj=40; nitem=20; eff=160
# A tibble: 5 × 7
     id   eff n_sing n_nonconv n_sig     N power
  &lt;int&gt; &lt;dbl&gt;  &lt;int&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
1     1     0    298       309    64  1000 0.064
2     2    40    257       270   200  1000 0.2
3     3    80    282       293   577  1000 0.577
4     4   120    271       283   844  1000 0.844
5     5   160    279       287   982  1000 0.982
results saved to &#39;sim-results_1000_0.00_160.00_5_40_20.rds&#39;</code></pre>
<!--chapter:end:02_mixed-effects.Rmd-->
</div>
</div>
<div id="references-and-further-reading" class="section level1" number="3">
<h1><span class="header-section-number">3</span> References and Further Reading</h1>
<div id="further-reading" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Further reading</h2>
<ul>
<li><p>How to justify your sample size <span class="citation">(<a href="#ref-Lakens_2022">Lakens, 2022</a>)</span>.</p></li>
<li><p>My tutorial with Lisa DeBruine <span class="citation">(<a href="#ref-DeBruine_Barr_2021">DeBruine &amp; Barr, 2021</a>)</span> which covers much of the same ground, but is mainly focused on <em>understanding</em> how LMEMs work</p></li>
<li><p>Other articles on power in LMEMs: <span class="citation">(<a href="#ref-Brysbaert_Stevens_2018">Brysbaert &amp; Stevens, 2018</a>)</span>, <span class="citation">(<a href="#ref-Kumle_Vo_Draschkow_2021">Kumle et al., 2021</a>)</span>, <span class="citation">(<a href="#ref-Westfall_Kenny_Judd_2014">Westfall et al., 2014</a>)</span></p></li>
<li><p>Monte Carlo simulations comparing methods for getting <span class="math inline">\(p\)</span>-values: <span class="citation">(<a href="#ref-Luke_2017">Luke, 2017</a>)</span></p></li>
</ul>
<p>Check out the <a href="https://psyteachr.github.io/">online textbooks</a> and resources that my group and University of Glasgow have been developing. There are great resources to learn more about data wrangling and visualization, among other things.</p>
</div>
<div id="r-packages" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> R packages</h2>
<ul>
<li>The <strong><code>{simr}</code></strong> package <span class="citation">(<a href="#ref-Green_2016">Green &amp; MacLeod, 2016</a>)</span></li>
<li>The <a href="https://debruine.github.io/faux/"><strong><code>{faux}</code></strong> package</a> for factorial simulation</li>
</ul>
</div>
<div id="references" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> References</h2>
<!--chapter:end:99_references.Rmd-->
<div id="refs" class="references csl-bib-body hanging-indent" line-spacing="2">
<div id="ref-Brysbaert_Stevens_2018" class="csl-entry">
Brysbaert, M., &amp; Stevens, M. (2018). Power analysis and effect size in mixed effects models: A tutorial. <em><span>Journal of Cognition</span></em>, <em>1</em>(1).
</div>
<div id="ref-DeBruine_Barr_2021" class="csl-entry">
DeBruine, L. M., &amp; Barr, D. J. (2021). Understanding mixed-effects models through data simulation. <em>Advances in Methods and Practices in Psychological Science</em>, <em>4</em>(1), 2515245920965119.
</div>
<div id="ref-Green_2016" class="csl-entry">
Green, P., &amp; MacLeod, C. J. (2016). <span class="nocase">SIMR: An R package for power analysis of generalized linear mixed models by simulation</span>. <em><span>Methods in Ecology and Evolution</span></em>, <em>7</em>(4), 493–498.
</div>
<div id="ref-Kumle_Vo_Draschkow_2021" class="csl-entry">
Kumle, L., Võ, M. L.-H., &amp; Draschkow, D. (2021). <span class="nocase">Estimating power in (generalized) linear mixed models: An open introduction and tutorial in R</span>. <em><span>Behavior Research Methods</span></em>, <em>53</em>(6), 2528–2543.
</div>
<div id="ref-Lakens_2022" class="csl-entry">
Lakens, D. (2022). Sample size justification. <em><span>Collabra: Psychology</span></em>, <em>8</em>(1), 33267. https://doi.org/<a href="https://doi.org/10.1525/collabra.33267">https://doi.org/10.1525/collabra.33267</a>
</div>
<div id="ref-Luke_2017" class="csl-entry">
Luke, S. G. (2017). <span class="nocase">Evaluating significance in linear mixed-effects models in R</span>. <em><span>Behavior Research Methods</span></em>, <em>49</em>, 1494–1502.
</div>
<div id="ref-Westfall_Kenny_Judd_2014" class="csl-entry">
Westfall, J., Kenny, D. A., &amp; Judd, C. M. (2014). Statistical power and optimal design in experiments in which samples of participants respond to samples of stimuli. <em><span>Journal of Experimental Psychology: General</span></em>, <em>143</em>(5), 2020.
</div>
</div>
</div>
</div>
<!--bookdown:body:end-->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  if (t = document.getElementById("webex-total_correct")) {
    t.innerHTML =
      document.getElementsByClassName("webex-correct").length + " of " +
      document.getElementsByClassName("webex-solveme").length + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

window.onload = function() {
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;
  }

  update_total_correct();
}

</script>
<script>
$( document ).ready(function() {
  var cite = ' ';
  var psyteachr = ' <a href="https://psyteachr.github.io/"><img src="images/logos/psyteachr_logo.png" style="height: 31px; color: white;" alt="psyTeachR: Reproducible Research" /></a>';
  var license = ' <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/" target="blank"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a>';

  $("footer div.row div:eq(1) p").html(
    psyteachr + license + cite
  );
});
</script>

  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Simulating power for mixed-effects models</strong>" was written by Dale J. Barr. It was last built on 2025-07-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
<script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>

</html>
